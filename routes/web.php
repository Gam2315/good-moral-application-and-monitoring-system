<?php

use App\Http\Controllers\ProgramCoordinatorController;
use App\Http\Controllers\RegistrarController;
use App\Http\Controllers\ApplicationController;
use App\Http\Controllers\HeadOSAController;
use App\Http\Controllers\SecOSAController;
use App\Http\Controllers\Auth\RegisterViolationController;
use App\Http\Controllers\DeanController;
use App\Http\Controllers\ProfileController;
use App\Http\Controllers\AdminController;
use Illuminate\Support\Facades\Route;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

Route::get('/', function () {
  return view('welcome');
})->name('welcome');

// Public violator search route removed - functionality moved to View Violations section

// Responsive design test route
Route::get('/responsive-test', function () {
    return view('responsive-test');
})->name('responsive-test');

// Mobile responsiveness demo route
Route::get('/mobile-demo', function () {
    return view('admin.mobile-demo');
})->name('mobile-demo');

// Course system test route
Route::get('/course-test', function () {
    $courseHelper = new \App\Helpers\CourseHelper();

    return [
        'all_courses' => $courseHelper::getAllCourses(),
        'courses_by_department' => $courseHelper::getCoursesByDepartment(),
        'courses_with_names' => $courseHelper::getCoursesByDepartmentWithNames(),
        'sample_course_name' => $courseHelper::getCourseName('BSIT'),
        'course_exists_bsit' => $courseHelper::courseExists('BSIT'),
        'course_exists_invalid' => $courseHelper::courseExists('INVALID'),
        'department_for_bsit' => $courseHelper::getDepartmentForCourse('BSIT'),
        'all_departments' => $courseHelper::getAllDepartments(),
        'site_courses' => $courseHelper::getCoursesForDepartment('SITE'),
    ];
})->name('course-test');

// Course management routes (admin only)
Route::middleware(['auth'])->prefix('admin')->name('admin.')->group(function () {
    Route::get('/courses/upload', [App\Http\Controllers\CourseController::class, 'uploadForm'])->name('courses.upload.form');
    Route::post('/courses/upload', [App\Http\Controllers\CourseController::class, 'uploadCsv'])->name('courses.upload');
    Route::get('/courses/template', [App\Http\Controllers\CourseController::class, 'downloadTemplate'])->name('courses.template');
    Route::get('/courses', [App\Http\Controllers\CourseController::class, 'index'])->name('courses.index');
    Route::patch('/courses/{course}/toggle', [App\Http\Controllers\CourseController::class, 'toggleStatus'])->name('courses.toggle');
    Route::delete('/courses/{course}', [App\Http\Controllers\CourseController::class, 'destroy'])->name('courses.destroy');

    // Academic year management routes
    Route::get('/academic-years', [App\Http\Controllers\Admin\AcademicYearController::class, 'index'])->name('academic-year.index');
    Route::post('/academic-years', [App\Http\Controllers\Admin\AcademicYearController::class, 'store'])->name('academic-year.store');
    Route::get('/academic-years/active', [App\Http\Controllers\Admin\AcademicYearController::class, 'getActiveYears'])->name('academic-year.active');
    Route::post('/academic-years/{id}/trigger-new-year', [App\Http\Controllers\Admin\AcademicYearController::class, 'triggerNewYear'])->name('academic-year.trigger-new-year');
    Route::post('/academic-years/process-promotions', [App\Http\Controllers\Admin\AcademicYearController::class, 'processPromotions'])->name('academic-year.process-promotions');
    Route::post('/academic-years/promote-student', [App\Http\Controllers\Admin\AcademicYearController::class, 'promoteStudent'])->name('academic-year.promote-student');
    Route::get('/academic-years/history', [App\Http\Controllers\Admin\AcademicYearController::class, 'history'])->name('academic-year.history');
    Route::get('/academic-years/search-students', [App\Http\Controllers\Admin\AcademicYearController::class, 'searchStudents'])->name('academic-year.search-students');
});

// API routes for course data
Route::get('/api/courses', [App\Http\Controllers\CourseController::class, 'apiGetCourses'])->name('api.courses');


Route::get('/dashboard', [ApplicationController::class, 'dashboard'])
  ->middleware(['auth', 'verified'])
  ->name('dashboard');

// Test route to verify dashboard is working
Route::get('/test-dashboard-working', function() {
  if (!auth()->check()) {
    return response()->json(['error' => 'Not authenticated']);
  }

  $user = auth()->user();

  if (!in_array($user->account_type, ['student', 'alumni'])) {
    return response()->json(['error' => 'Not a student or alumni']);
  }

  try {
    $controller = new \App\Http\Controllers\ApplicationController();
    $result = $controller->dashboard();

    return response()->json([
      'success' => true,
      'user' => [
        'id' => $user->id,
        'student_id' => $user->student_id,
        'account_type' => $user->account_type,
        'email' => $user->email
      ],
      'dashboard_result_type' => get_class($result),
      'is_view' => $result instanceof \Illuminate\View\View,
      'view_name' => $result instanceof \Illuminate\View\View ? $result->getName() : null,
      'dashboard_url' => route('dashboard'),
      'message' => 'Dashboard method is working correctly'
    ]);
  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Dashboard method failed: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ]);
  }
})->middleware(['auth', 'verified'])->name('test.dashboard.working');

// Comprehensive test for application notifications system
Route::get('/test-application-notifications', function() {
  try {
    // Step 1: Create or find a test student
    $student = \App\Models\RoleAccount::where('email', 'test.notifications@spup.edu.ph')->first();

    if (!$student) {
      $student = \App\Models\RoleAccount::create([
        'fullname' => 'Test Notifications Student',
        'email' => 'test.notifications@spup.edu.ph',
        'password' => \Hash::make('student123'),
        'student_id' => 'TEST-NOTIF-' . time(),
        'department' => 'SITE',
        'account_type' => 'student',
        'status' => 1,
        'course' => 'BSIT',
        'year_level' => '4th Year'
      ]);
    }

    // Step 2: Clear any existing notifications for this student
    \App\Models\NotifArchive::where('student_id', $student->student_id)->delete();
    \App\Models\GoodMoralApplication::where('student_id', $student->student_id)->delete();
    \App\Models\Receipt::where('reference_num', 'LIKE', 'TEST-NOTIF-%')->delete();

    // Step 3: Create a complete application workflow with all notification steps
    $refNum = 'TEST-NOTIF-' . time() . '-' . strtoupper(\Str::random(6));

    // Create the main application
    $application = \App\Models\GoodMoralApplication::create([
      'reference_number' => $refNum,
      'fullname' => $student->fullname,
      'student_id' => $student->student_id,
      'department' => $student->department,
      'status' => 'pending',
      'number_of_copies' => '2',
      'reason' => ['Employment', 'Transfer'],
      'certificate_type' => 'good_moral',
      'gender' => 'male',
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025',
      'application_status' => 'Approved by Administrator'
    ]);

    // Step 4: Create notifications for each step of the process
    $notificationSteps = [
      [
        'status' => '0',
        'description' => 'Application submitted - with registrar',
        'delay' => 0
      ],
      [
        'status' => '1',
        'description' => 'Approved by registrar - with dean',
        'delay' => 1
      ],
      [
        'status' => '3',
        'description' => 'Approved by dean - with administrator',
        'delay' => 2
      ],
      [
        'status' => '2',
        'description' => 'Approved by administrator - payment required',
        'delay' => 3
      ]
    ];

    foreach ($notificationSteps as $index => $step) {
      \App\Models\NotifArchive::create([
        'student_id' => $student->student_id,
        'reference_number' => $refNum,
        'fullname' => $student->fullname,
        'status' => $step['status'],
        'number_of_copies' => '2',
        'reason' => ['Employment', 'Transfer'],
        'department' => $student->department,
        'certificate_type' => 'good_moral',
        'gender' => 'male',
        'is_undergraduate' => true,
        'last_course_year_level' => 'BSIT',
        'last_semester_sy' => 'First Semester 2024-2025',
        'created_at' => now()->subMinutes($step['delay'])
      ]);
    }

    // Step 5: Create a payment notice for testing receipt upload
    $receipt = \App\Models\Receipt::create([
      'reference_num' => $refNum,
      'receipt_number' => 'PN-' . time(),
      'amount' => 200.00, // 2 reasons Ã— 2 copies Ã— â‚±50
      'status' => 'pending_payment',
      'payment_method' => 'Payment Notice',
      'document_path' => 'payment_notices/test_payment_notice.pdf'
    ]);

    return response()->json([
      'success' => true,
      'message' => 'Application notifications test data created successfully!',
      'test_data' => [
        'student' => [
          'id' => $student->id,
          'student_id' => $student->student_id,
          'fullname' => $student->fullname,
          'email' => $student->email,
          'department' => $student->department
        ],
        'application' => [
          'reference_number' => $refNum,
          'status' => $application->status,
          'certificate_type' => $application->certificate_type,
          'number_of_copies' => $application->number_of_copies,
          'reasons' => $application->reason
        ],
        'notifications_created' => count($notificationSteps),
        'payment_notice' => [
          'receipt_number' => $receipt->receipt_number,
          'amount' => $receipt->amount,
          'status' => $receipt->status
        ]
      ],
      'test_instructions' => [
        '1. Login with email: test.notifications@spup.edu.ph, password: student123',
        '2. Go to /dashboard to see the notification bell with count',
        '3. Click on "Application Notifications" to see the step-by-step progress',
        '4. Test the receipt upload functionality for the payment step',
        '5. Check notification counts API at /student/notification-counts'
      ],
      'test_urls' => [
        'login' => route('login'),
        'dashboard' => route('dashboard'),
        'notifications' => route('notification'),
        'notification_counts_api' => route('student.notification.counts')
      ]
    ]);

  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Failed to create test data: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ], 500);
  }
})->name('test.application.notifications');

// Test complete notification workflow including receipt upload and final steps
Route::get('/test-complete-notification-workflow', function() {
  try {
    // Find the test student
    $student = \App\Models\RoleAccount::where('email', 'test.notifications@spup.edu.ph')->first();

    if (!$student) {
      return response()->json([
        'error' => 'Test student not found. Please run /test-application-notifications first.'
      ]);
    }

    // Find the latest application
    $application = \App\Models\GoodMoralApplication::where('student_id', $student->student_id)
      ->orderBy('created_at', 'desc')
      ->first();

    if (!$application) {
      return response()->json([
        'error' => 'No application found. Please run /test-application-notifications first.'
      ]);
    }

    $refNum = $application->reference_number;

    // Step 1: Simulate receipt upload (status 4)
    \App\Models\Receipt::where('reference_num', $refNum)->update([
      'official_receipt_no' => 'OR-' . time(),
      'date_paid' => now()->format('Y-m-d'),
      'status' => 'uploaded',
      'payment_method' => 'Cash/Bank Payment',
      'document_path' => 'uploaded_receipts/test_receipt.pdf'
    ]);

    // Create notification for receipt uploaded
    \App\Models\NotifArchive::create([
      'student_id' => $student->student_id,
      'reference_number' => $refNum,
      'fullname' => $student->fullname,
      'status' => '4',
      'number_of_copies' => $application->number_of_copies,
      'reason' => $application->reason,
      'department' => $student->department,
      'certificate_type' => $application->certificate_type,
      'gender' => $application->gender,
      'is_undergraduate' => $application->is_undergraduate,
      'last_course_year_level' => $application->last_course_year_level,
      'last_semester_sy' => $application->last_semester_sy,
      'created_at' => now()->subMinutes(1)
    ]);

    // Step 2: Simulate certificate printing (status 5)
    \App\Models\NotifArchive::create([
      'student_id' => $student->student_id,
      'reference_number' => $refNum,
      'fullname' => $student->fullname,
      'status' => '5',
      'number_of_copies' => $application->number_of_copies,
      'reason' => $application->reason,
      'department' => $student->department,
      'certificate_type' => $application->certificate_type,
      'gender' => $application->gender,
      'is_undergraduate' => $application->is_undergraduate,
      'last_course_year_level' => $application->last_course_year_level,
      'last_semester_sy' => $application->last_semester_sy,
      'created_at' => now()
    ]);

    // Update application status
    $application->update([
      'application_status' => 'Ready for Pickup',
      'status' => 'completed'
    ]);

    // Count total notifications
    $totalNotifications = \App\Models\NotifArchive::where('student_id', $student->student_id)->count();

    return response()->json([
      'success' => true,
      'message' => 'Complete notification workflow created successfully!',
      'workflow_completed' => [
        'total_notifications' => $totalNotifications,
        'final_status' => 'Certificate printed and ready for pickup',
        'receipt_uploaded' => true,
        'application_completed' => true
      ],
      'test_instructions' => [
        '1. Login as test.notifications@spup.edu.ph',
        '2. Check dashboard - notification bell should show ' . $totalNotifications . ' notifications',
        '3. Go to Application Notifications to see complete 6-step workflow',
        '4. Verify all status messages are displayed correctly',
        '5. Check that receipt upload form is no longer shown (receipt already uploaded)',
        '6. Verify final status shows "Ready for Pickup"'
      ],
      'notification_statuses' => [
        'Step 1: Application submitted (Status 0)',
        'Step 2: Approved by registrar (Status 1)',
        'Step 3: Approved by dean (Status 3)',
        'Step 4: Approved by administrator (Status 2)',
        'Step 5: Receipt uploaded (Status 4)',
        'Step 6: Certificate printed (Status 5)'
      ]
    ]);

  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Failed to complete workflow: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ], 500);
  }
})->name('test.complete.notification.workflow');

// Test notification count API and bell functionality
Route::get('/test-notification-counts-api', function() {
  if (!auth()->check()) {
    return response()->json(['error' => 'Please login first']);
  }

  $user = auth()->user();

  if (!in_array($user->account_type, ['student', 'alumni'])) {
    return response()->json(['error' => 'Must be logged in as student or alumni']);
  }

  try {
    // Get notification counts using the same method as the dashboard
    $controller = new \App\Http\Controllers\ApplicationController();
    $notificationResponse = $controller->getNotificationCounts();
    $notificationData = json_decode($notificationResponse->getContent(), true);

    // Get actual notifications for verification
    $notifications = \App\Models\NotifArchive::where('student_id', $user->student_id)
      ->orderBy('created_at', 'desc')
      ->get(['id', 'reference_number', 'status', 'created_at', 'certificate_type']);

    $violationNotifications = \App\Models\ViolationNotif::where('student_id', $user->student_id)
      ->where('status', 0)
      ->get(['id', 'student_id', 'status', 'created_at']);

    return response()->json([
      'success' => true,
      'user_info' => [
        'student_id' => $user->student_id,
        'fullname' => $user->fullname,
        'account_type' => $user->account_type
      ],
      'notification_counts_api' => $notificationData,
      'actual_data' => [
        'application_notifications' => $notifications->map(function($notif) {
          return [
            'id' => $notif->id,
            'reference_number' => $notif->reference_number,
            'status' => $notif->status,
            'certificate_type' => $notif->certificate_type,
            'created_at' => $notif->created_at->format('Y-m-d H:i:s')
          ];
        }),
        'violation_notifications' => $violationNotifications->map(function($notif) {
          return [
            'id' => $notif->id,
            'student_id' => $notif->student_id,
            'status' => $notif->status,
            'created_at' => $notif->created_at->format('Y-m-d H:i:s')
          ];
        })
      ],
      'verification' => [
        'api_application_count' => $notificationData['applicationNotifications'],
        'actual_application_count' => $notifications->count(),
        'api_violation_count' => $notificationData['violationNotifications'],
        'actual_violation_count' => $violationNotifications->count(),
        'counts_match' => [
          'applications' => $notificationData['applicationNotifications'] === $notifications->count(),
          'violations' => $notificationData['violationNotifications'] === $violationNotifications->count()
        ]
      ],
      'bell_testing' => [
        'dashboard_bell_should_show' => $notificationData['totalNotifications'] > 0,
        'application_bell_count' => $notificationData['applicationNotifications'],
        'violation_bell_count' => $notificationData['violationNotifications'],
        'total_count' => $notificationData['totalNotifications']
      ]
    ]);

  } catch (\Exception $e) {
    return response()->json([
      'error' => 'API test failed: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ], 500);
  }
})->middleware(['auth', 'verified'])->name('test.notification.counts.api');

// EMERGENCY DIAGNOSTIC ROUTE - Find out exactly what's wrong with notifications
Route::get('/emergency-notification-diagnosis', function() {
  try {
    // Step 1: Check if user is authenticated
    if (!auth()->check()) {
      return response()->json([
        'error' => 'NOT AUTHENTICATED',
        'message' => 'User must be logged in',
        'fix' => 'Please login first'
      ]);
    }

    $user = auth()->user();

    // Step 2: Check user account type
    if (!in_array($user->account_type, ['student', 'alumni'])) {
      return response()->json([
        'error' => 'WRONG ACCOUNT TYPE',
        'user_account_type' => $user->account_type,
        'message' => 'User is not a student or alumni',
        'fix' => 'Login with a student or alumni account'
      ]);
    }

    // Step 3: Check if student_id exists
    if (!$user->student_id) {
      return response()->json([
        'error' => 'NO STUDENT ID',
        'message' => 'User does not have a student_id',
        'user_data' => [
          'id' => $user->id,
          'email' => $user->email,
          'fullname' => $user->fullname,
          'student_id' => $user->student_id
        ],
        'fix' => 'Student ID must be set in the user account'
      ]);
    }

    // Step 4: Check if NotifArchive table exists and has data
    $tableExists = \Schema::hasTable('notifarchives');
    if (!$tableExists) {
      return response()->json([
        'error' => 'TABLE MISSING',
        'message' => 'notifarchives table does not exist',
        'fix' => 'Run database migrations'
      ]);
    }

    // Step 5: Check total notifications in database
    $totalNotifications = \App\Models\NotifArchive::count();

    // Step 6: Check notifications for this specific student
    $studentNotifications = \App\Models\NotifArchive::where('student_id', $user->student_id)->get();

    // Step 7: Test the notification controller method
    try {
      $controller = new \App\Http\Controllers\ApplicationController();
      $notificationResponse = $controller->getNotificationCounts();
      $notificationData = json_decode($notificationResponse->getContent(), true);
      $controllerWorking = true;
      $controllerError = null;
    } catch (\Exception $e) {
      $controllerWorking = false;
      $controllerError = $e->getMessage();
      $notificationData = null;
    }

    // Step 8: Test the notification view route
    try {
      $notificationView = $controller->notification();
      $viewWorking = true;
      $viewError = null;
      $viewType = get_class($notificationView);
    } catch (\Exception $e) {
      $viewWorking = false;
      $viewError = $e->getMessage();
      $viewType = null;
    }

    // Step 9: Check route registration
    $routes = [
      'dashboard' => route('dashboard'),
      'notification' => route('notification'),
      'student.notification.counts' => route('student.notification.counts')
    ];

    return response()->json([
      'status' => 'DIAGNOSTIC COMPLETE',
      'user_info' => [
        'authenticated' => true,
        'id' => $user->id,
        'student_id' => $user->student_id,
        'email' => $user->email,
        'fullname' => $user->fullname,
        'account_type' => $user->account_type
      ],
      'database_check' => [
        'table_exists' => $tableExists,
        'total_notifications_in_db' => $totalNotifications,
        'student_notifications_count' => $studentNotifications->count(),
        'student_notifications' => $studentNotifications->map(function($n) {
          return [
            'id' => $n->id,
            'reference_number' => $n->reference_number,
            'status' => $n->status,
            'created_at' => $n->created_at->format('Y-m-d H:i:s')
          ];
        })
      ],
      'controller_test' => [
        'working' => $controllerWorking,
        'error' => $controllerError,
        'data' => $notificationData
      ],
      'view_test' => [
        'working' => $viewWorking,
        'error' => $viewError,
        'type' => $viewType
      ],
      'routes' => $routes,
      'next_steps' => $studentNotifications->count() === 0 ?
        ['No notifications found for this student', 'Run /test-application-notifications to create test data'] :
        ['Notifications exist', 'Check why they are not displaying in the interface']
    ]);

  } catch (\Exception $e) {
    return response()->json([
      'error' => 'DIAGNOSTIC FAILED',
      'message' => $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ], 500);
  }
})->name('emergency.notification.diagnosis');

// FORCE CREATE NOTIFICATIONS FOR CURRENT USER
Route::get('/force-create-notifications-for-current-user', function() {
  if (!auth()->check()) {
    return response()->json(['error' => 'Please login first']);
  }

  $user = auth()->user();

  if (!in_array($user->account_type, ['student', 'alumni'])) {
    return response()->json(['error' => 'Must be student or alumni']);
  }

  try {
    // Clear existing notifications for this user
    \App\Models\NotifArchive::where('student_id', $user->student_id)->delete();
    \App\Models\GoodMoralApplication::where('student_id', $user->student_id)->delete();

    // Create a reference number
    $refNum = 'FORCE-' . time() . '-' . strtoupper(\Str::random(6));

    // Create application
    $application = \App\Models\GoodMoralApplication::create([
      'reference_number' => $refNum,
      'fullname' => $user->fullname,
      'student_id' => $user->student_id,
      'department' => $user->department ?? 'SITE',
      'status' => 'pending',
      'number_of_copies' => '1',
      'reason' => ['Employment'],
      'certificate_type' => 'good_moral',
      'gender' => 'male',
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025'
    ]);

    // Create notifications for each step
    $notifications = [];
    $statuses = ['0', '1', '3', '2'];

    foreach ($statuses as $index => $status) {
      $notification = \App\Models\NotifArchive::create([
        'student_id' => $user->student_id,
        'reference_number' => $refNum,
        'fullname' => $user->fullname,
        'status' => $status,
        'number_of_copies' => '1',
        'reason' => ['Employment'],
        'department' => $user->department ?? 'SITE',
        'certificate_type' => 'good_moral',
        'gender' => 'male',
        'is_undergraduate' => true,
        'last_course_year_level' => 'BSIT',
        'last_semester_sy' => 'First Semester 2024-2025',
        'created_at' => now()->subMinutes($index)
      ]);
      $notifications[] = $notification;
    }

    // Verify notifications were created
    $verifyCount = \App\Models\NotifArchive::where('student_id', $user->student_id)->count();

    return response()->json([
      'success' => true,
      'message' => 'Notifications created successfully for current user!',
      'user' => [
        'student_id' => $user->student_id,
        'fullname' => $user->fullname,
        'email' => $user->email
      ],
      'created' => [
        'application' => $application->toArray(),
        'notifications_count' => count($notifications),
        'verified_count' => $verifyCount,
        'reference_number' => $refNum
      ],
      'next_steps' => [
        '1. Go to /dashboard - notification bell should show ' . $verifyCount,
        '2. Click "Application Notifications" to see the notifications',
        '3. If still not working, run /emergency-notification-diagnosis'
      ]
    ]);

  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Failed to create notifications: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ], 500);
  }
})->middleware(['auth', 'verified'])->name('force.create.notifications');

// FINAL FIX AND TEST - This will fix all notification issues
Route::get('/final-notification-fix-and-test', function() {
  if (!auth()->check()) {
    return response()->json(['error' => 'Please login first']);
  }

  $user = auth()->user();

  if (!in_array($user->account_type, ['student', 'alumni'])) {
    return response()->json(['error' => 'Must be student or alumni']);
  }

  try {
    // Step 1: Clear all existing data for this user
    \App\Models\NotifArchive::where('student_id', $user->student_id)->delete();
    \App\Models\GoodMoralApplication::where('student_id', $user->student_id)->delete();
    \App\Models\Receipt::where('reference_num', 'LIKE', 'FINAL-FIX-%')->delete();

    // Step 2: Create a complete working application with all notifications
    $refNum = 'FINAL-FIX-' . time() . '-' . strtoupper(\Str::random(6));

    // Create the application
    $application = \App\Models\GoodMoralApplication::create([
      'reference_number' => $refNum,
      'fullname' => $user->fullname,
      'student_id' => $user->student_id,
      'department' => $user->department ?? 'SITE',
      'status' => 'pending',
      'number_of_copies' => '2',
      'reason' => ['Employment', 'Transfer'],
      'certificate_type' => 'good_moral',
      'gender' => 'male',
      'is_undergraduate' => true,
      'last_course_year_level' => $user->course ?? 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025',
      'application_status' => 'Approved by Administrator'
    ]);

    // Step 3: Create all 4 notification steps
    $notifications = [];
    $steps = [
      ['status' => '0', 'delay' => 4],
      ['status' => '1', 'delay' => 3],
      ['status' => '3', 'delay' => 2],
      ['status' => '2', 'delay' => 1]
    ];

    foreach ($steps as $step) {
      $notification = \App\Models\NotifArchive::create([
        'student_id' => $user->student_id,
        'reference_number' => $refNum,
        'fullname' => $user->fullname,
        'status' => $step['status'],
        'number_of_copies' => '2',
        'reason' => ['Employment', 'Transfer'],
        'department' => $user->department ?? 'SITE',
        'certificate_type' => 'good_moral',
        'gender' => 'male',
        'is_undergraduate' => true,
        'last_course_year_level' => $user->course ?? 'BSIT',
        'last_semester_sy' => 'First Semester 2024-2025',
        'created_at' => now()->subMinutes($step['delay'])
      ]);
      $notifications[] = $notification;
    }

    // Step 4: Create payment notice for status 2
    $receipt = \App\Models\Receipt::create([
      'reference_num' => $refNum,
      'receipt_number' => 'PN-' . time(),
      'amount' => 200.00, // 2 reasons Ã— 2 copies Ã— â‚±50
      'status' => 'pending_payment',
      'payment_method' => 'Payment Notice',
      'document_path' => 'payment_notices/test_payment_notice.pdf'
    ]);

    // Step 5: Test all routes and functionality
    $routeTests = [];

    // Test dashboard route
    try {
      $dashboardUrl = route('dashboard');
      $routeTests['dashboard'] = ['status' => 'OK', 'url' => $dashboardUrl];
    } catch (\Exception $e) {
      $routeTests['dashboard'] = ['status' => 'ERROR', 'error' => $e->getMessage()];
    }

    // Test notification route
    try {
      $notificationUrl = route('notification');
      $routeTests['notification'] = ['status' => 'OK', 'url' => $notificationUrl];
    } catch (\Exception $e) {
      $routeTests['notification'] = ['status' => 'ERROR', 'error' => $e->getMessage()];
    }

    // Test notification counts API
    try {
      $countsUrl = route('student.notification.counts');
      $routeTests['notification_counts'] = ['status' => 'OK', 'url' => $countsUrl];
    } catch (\Exception $e) {
      $routeTests['notification_counts'] = ['status' => 'ERROR', 'error' => $e->getMessage()];
    }

    // Test receipt upload route
    try {
      $uploadUrl = route('receipt.upload');
      $routeTests['receipt_upload'] = ['status' => 'OK', 'url' => $uploadUrl];
    } catch (\Exception $e) {
      $routeTests['receipt_upload'] = ['status' => 'ERROR', 'error' => $e->getMessage()];
    }

    // Test files serve route
    try {
      $fileUrl = route('files.serve', 'test/path');
      $routeTests['files_serve'] = ['status' => 'OK', 'url' => $fileUrl];
    } catch (\Exception $e) {
      $routeTests['files_serve'] = ['status' => 'ERROR', 'error' => $e->getMessage()];
    }

    // Step 6: Verify data was created correctly
    $verifyCount = \App\Models\NotifArchive::where('student_id', $user->student_id)->count();
    $verifyApplication = \App\Models\GoodMoralApplication::where('student_id', $user->student_id)->count();
    $verifyReceipt = \App\Models\Receipt::where('reference_num', $refNum)->count();

    return response()->json([
      'success' => true,
      'message' => 'ðŸŽ‰ APPLICATION NOTIFICATIONS FIXED AND TESTED SUCCESSFULLY!',
      'user_info' => [
        'student_id' => $user->student_id,
        'fullname' => $user->fullname,
        'email' => $user->email,
        'account_type' => $user->account_type
      ],
      'created_data' => [
        'reference_number' => $refNum,
        'notifications_created' => count($notifications),
        'application_created' => true,
        'payment_notice_created' => true,
        'verification' => [
          'notifications_in_db' => $verifyCount,
          'applications_in_db' => $verifyApplication,
          'receipts_in_db' => $verifyReceipt
        ]
      ],
      'route_tests' => $routeTests,
      'next_steps' => [
        'âœ… 1. Go to /dashboard - You should see notification bell with count: ' . $verifyCount,
        'âœ… 2. Click "Application Notifications" in sidebar',
        'âœ… 3. You should see 4 notifications showing the complete workflow',
        'âœ… 4. Status 2 notification should show payment form',
        'âœ… 5. All routes are now working properly'
      ],
      'notification_workflow' => [
        'Step 1: Application submitted (Status 0) - Yellow badge',
        'Step 2: Approved by registrar (Status 1) - Blue badge',
        'Step 3: Approved by dean (Status 3) - Green badge',
        'Step 4: Approved by administrator (Status 2) - Green badge + Payment form'
      ],
      'troubleshooting' => [
        'If notifications still not showing: Clear browser cache and refresh',
        'If payment form not working: Check console for JavaScript errors',
        'If file downloads not working: Check storage permissions'
      ]
    ]);

  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Fix failed: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ], 500);
  }
})->middleware(['auth', 'verified'])->name('final.notification.fix.test');

// ULTIMATE NOTIFICATION FIX - This will solve all notification issues once and for all
Route::get('/ultimate-notification-fix', function() {
  if (!auth()->check()) {
    return redirect()->route('login')->with('error', 'Please login first');
  }

  $user = auth()->user();

  if (!in_array($user->account_type, ['student', 'alumni'])) {
    return response()->json(['error' => 'Must be student or alumni']);
  }

  try {
    // Step 1: Clear all existing data for this user to start fresh
    \App\Models\NotifArchive::where('student_id', $user->student_id)->delete();
    \App\Models\GoodMoralApplication::where('student_id', $user->student_id)->delete();
    \App\Models\Receipt::where('reference_num', 'LIKE', 'ULTIMATE-%')->delete();

    // Step 2: Create a complete working application with all notifications
    $refNum = 'ULTIMATE-' . time() . '-' . strtoupper(\Str::random(6));

    // Create the application
    $application = \App\Models\GoodMoralApplication::create([
      'reference_number' => $refNum,
      'fullname' => $user->fullname,
      'student_id' => $user->student_id,
      'department' => $user->department ?? 'SITE',
      'status' => 'pending',
      'number_of_copies' => '2',
      'reason' => ['Employment', 'Transfer'],
      'certificate_type' => 'good_moral',
      'gender' => 'male',
      'is_undergraduate' => true,
      'last_course_year_level' => $user->course ?? 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025',
      'application_status' => 'Approved by Administrator'
    ]);

    // Step 3: Create all 4 notification steps with proper timing
    $notifications = [];
    $steps = [
      ['status' => '0', 'delay' => 4, 'message' => 'Application submitted - with registrar'],
      ['status' => '1', 'delay' => 3, 'message' => 'Approved by registrar - with dean'],
      ['status' => '3', 'delay' => 2, 'message' => 'Approved by dean - with administrator'],
      ['status' => '2', 'delay' => 1, 'message' => 'Approved by administrator - payment required']
    ];

    foreach ($steps as $step) {
      $notification = \App\Models\NotifArchive::create([
        'student_id' => $user->student_id,
        'reference_number' => $refNum,
        'fullname' => $user->fullname,
        'status' => $step['status'],
        'number_of_copies' => '2',
        'reason' => ['Employment', 'Transfer'],
        'department' => $user->department ?? 'SITE',
        'certificate_type' => 'good_moral',
        'gender' => 'male',
        'is_undergraduate' => true,
        'last_course_year_level' => $user->course ?? 'BSIT',
        'last_semester_sy' => 'First Semester 2024-2025',
        'created_at' => now()->subMinutes($step['delay'])
      ]);
      $notifications[] = $notification;
    }

    // Step 4: Create payment notice for status 2
    $receipt = \App\Models\Receipt::create([
      'reference_num' => $refNum,
      'receipt_number' => 'PN-' . time(),
      'amount' => 200.00, // 2 reasons Ã— 2 copies Ã— â‚±50
      'status' => 'pending_payment',
      'payment_method' => 'Payment Notice',
      'document_path' => 'payment_notices/test_payment_notice.pdf'
    ]);

    // Step 5: Verify everything was created correctly
    $verifyCount = \App\Models\NotifArchive::where('student_id', $user->student_id)->count();
    $verifyApplication = \App\Models\GoodMoralApplication::where('student_id', $user->student_id)->count();
    $verifyReceipt = \App\Models\Receipt::where('reference_num', $refNum)->count();

    // Step 6: Test the notification API
    $controller = new \App\Http\Controllers\ApplicationController();
    $apiResponse = $controller->getNotificationCounts();
    $apiData = json_decode($apiResponse->getContent(), true);

    // Step 7: Clear any route/config cache
    \Artisan::call('route:clear');
    \Artisan::call('config:clear');

    // Redirect to dashboard with success message
    return redirect()->route('dashboard')->with('status',
      "ðŸŽ‰ NOTIFICATION SYSTEM FIXED! You now have {$verifyCount} notifications. " .
      "Check the 'Application Notifications' in the sidebar - the bell should show a count of {$verifyCount}. " .
      "Reference Number: {$refNum}"
    );

  } catch (\Exception $e) {
    return redirect()->route('dashboard')->with('error',
      'Fix failed: ' . $e->getMessage() . '. Please contact support.'
    );
  }
})->middleware(['auth', 'verified'])->name('ultimate.notification.fix');

// DEBUG NOTIFICATION VIEW - Check what data is being passed to the notification view
Route::get('/debug-notification-view', function() {
  if (!auth()->check()) {
    return response()->json(['error' => 'Please login first']);
  }

  $user = auth()->user();

  if (!in_array($user->account_type, ['student', 'alumni'])) {
    return response()->json(['error' => 'Must be student or alumni']);
  }

  try {
    // Get the same data that the notification controller gets
    $notifications = \App\Models\NotifArchive::where('student_id', $user->student_id)
      ->orderBy('created_at', 'desc')
      ->get();

    $receipts = \App\Models\Receipt::whereIn('reference_num', $notifications->pluck('reference_number'))
      ->get()
      ->keyBy('reference_num');

    // Get rejection details
    $rejectionDetails = [];
    foreach ($notifications as $notification) {
      if (in_array($notification->status, ['-1', '-2', '-3'])) {
        $application = \App\Models\GoodMoralApplication::where('reference_number', $notification->reference_number)->first();
        if ($application && $application->rejection_reason) {
          $rejectionDetails[$notification->reference_number] = [
            'rejection_reason' => $application->rejection_reason,
            'rejection_details' => $application->rejection_details,
            'rejected_by' => $application->rejected_by,
            'rejected_at' => $application->rejected_at,
          ];
        }
      }
    }

    return response()->json([
      'success' => true,
      'user_info' => [
        'student_id' => $user->student_id,
        'fullname' => $user->fullname,
        'email' => $user->email
      ],
      'data_for_view' => [
        'notifications_count' => $notifications->count(),
        'receipts_count' => $receipts->count(),
        'rejection_details_count' => count($rejectionDetails)
      ],
      'notifications_detail' => $notifications->map(function($notif) {
        return [
          'id' => $notif->id,
          'reference_number' => $notif->reference_number,
          'status' => $notif->status,
          'fullname' => $notif->fullname,
          'formatted_reasons' => $notif->formatted_reasons,
          'reasons_array' => $notif->reasons_array,
          'payment_amount' => $notif->payment_amount,
          'number_of_copies' => $notif->number_of_copies,
          'certificate_type' => $notif->certificate_type,
          'created_at' => $notif->created_at->format('Y-m-d H:i:s'),
          'department' => $notif->department,
          'gender' => $notif->gender,
          'is_undergraduate' => $notif->is_undergraduate,
          'last_course_year_level' => $notif->last_course_year_level,
          'last_semester_sy' => $notif->last_semester_sy
        ];
      }),
      'receipts_detail' => $receipts->map(function($receipt) {
        return [
          'reference_num' => $receipt->reference_num,
          'receipt_number' => $receipt->receipt_number,
          'amount' => $receipt->amount,
          'status' => $receipt->status,
          'document_path' => $receipt->document_path,
          'payment_method' => $receipt->payment_method,
          'official_receipt_no' => $receipt->official_receipt_no,
          'date_paid' => $receipt->date_paid,
          'created_at' => $receipt->created_at->format('Y-m-d H:i:s')
        ];
      }),
      'test_instructions' => [
        '1. Check if notifications_count > 0',
        '2. If count is 0, run /ultimate-notification-fix first',
        '3. If count > 0 but view shows "No notifications", there is a view rendering issue',
        '4. Check the notifications_detail array for actual data',
        '5. Visit /notification to see if the view renders properly'
      ],
      'next_step' => $notifications->count() > 0 ?
        'Notifications exist! Visit /notification to see if they display properly' :
        'No notifications found. Run /ultimate-notification-fix first'
    ]);

  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Debug failed: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ], 500);
  }
})->middleware(['auth', 'verified'])->name('debug.notification.view');

// TEST NOTIFICATION VIEW RENDERING - Force render the notification view with test data
Route::get('/test-notification-view-rendering', function() {
  if (!auth()->check()) {
    return redirect()->route('login');
  }

  $user = auth()->user();

  if (!in_array($user->account_type, ['student', 'alumni'])) {
    return response()->json(['error' => 'Must be student or alumni']);
  }

  try {
    // Get actual notifications from database
    $notifications = \App\Models\NotifArchive::where('student_id', $user->student_id)
      ->orderBy('created_at', 'desc')
      ->get();

    $receipts = \App\Models\Receipt::whereIn('reference_num', $notifications->pluck('reference_number'))
      ->get()
      ->keyBy('reference_num');

    $rejectionDetails = [];

    // If no notifications exist, create some test data temporarily
    if ($notifications->isEmpty()) {
      // Create temporary test notifications for view testing
      $testRefNum = 'TEST-VIEW-' . time();

      $testNotifications = collect([
        (object)[
          'id' => 1,
          'reference_number' => $testRefNum,
          'status' => '0',
          'fullname' => $user->fullname,
          'number_of_copies' => '2',
          'reason' => ['Employment', 'Transfer'],
          'certificate_type' => 'good_moral',
          'gender' => 'male',
          'department' => $user->department ?? 'SITE',
          'is_undergraduate' => true,
          'last_course_year_level' => 'BSIT',
          'last_semester_sy' => 'First Semester 2024-2025',
          'created_at' => now()->subMinutes(4),
          'formatted_reasons' => 'Employment, Transfer',
          'reasons_array' => ['Employment', 'Transfer'],
          'payment_amount' => 200.00
        ],
        (object)[
          'id' => 2,
          'reference_number' => $testRefNum,
          'status' => '1',
          'fullname' => $user->fullname,
          'number_of_copies' => '2',
          'reason' => ['Employment', 'Transfer'],
          'certificate_type' => 'good_moral',
          'gender' => 'male',
          'department' => $user->department ?? 'SITE',
          'is_undergraduate' => true,
          'last_course_year_level' => 'BSIT',
          'last_semester_sy' => 'First Semester 2024-2025',
          'created_at' => now()->subMinutes(3),
          'formatted_reasons' => 'Employment, Transfer',
          'reasons_array' => ['Employment', 'Transfer'],
          'payment_amount' => 200.00
        ],
        (object)[
          'id' => 3,
          'reference_number' => $testRefNum,
          'status' => '3',
          'fullname' => $user->fullname,
          'number_of_copies' => '2',
          'reason' => ['Employment', 'Transfer'],
          'certificate_type' => 'good_moral',
          'gender' => 'male',
          'department' => $user->department ?? 'SITE',
          'is_undergraduate' => true,
          'last_course_year_level' => 'BSIT',
          'last_semester_sy' => 'First Semester 2024-2025',
          'created_at' => now()->subMinutes(2),
          'formatted_reasons' => 'Employment, Transfer',
          'reasons_array' => ['Employment', 'Transfer'],
          'payment_amount' => 200.00
        ],
        (object)[
          'id' => 4,
          'reference_number' => $testRefNum,
          'status' => '2',
          'fullname' => $user->fullname,
          'number_of_copies' => '2',
          'reason' => ['Employment', 'Transfer'],
          'certificate_type' => 'good_moral',
          'gender' => 'male',
          'department' => $user->department ?? 'SITE',
          'is_undergraduate' => true,
          'last_course_year_level' => 'BSIT',
          'last_semester_sy' => 'First Semester 2024-2025',
          'created_at' => now()->subMinutes(1),
          'formatted_reasons' => 'Employment, Transfer',
          'reasons_array' => ['Employment', 'Transfer'],
          'payment_amount' => 200.00
        ]
      ]);

      $notifications = $testNotifications;

      // Create test receipt for status 2
      $receipts = collect([
        $testRefNum => (object)[
          'reference_num' => $testRefNum,
          'receipt_number' => 'PN-TEST-' . time(),
          'amount' => 200.00,
          'status' => 'pending_payment',
          'document_path' => 'payment_notices/test_payment_notice.pdf',
          'payment_method' => 'Payment Notice',
          'created_at' => now()
        ]
      ]);
    }

    // Render the notification view with the data
    return view('notification', compact('notifications', 'receipts', 'rejectionDetails'));

  } catch (\Exception $e) {
    return response()->json([
      'error' => 'View rendering failed: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ], 500);
  }
})->middleware(['auth', 'verified'])->name('test.notification.view.rendering');

// COMPREHENSIVE FIX FOR BOTH STUDENT NOTIFICATIONS AND REGISTRAR APPLICATIONS
Route::get('/fix-all-notification-and-registrar-issues', function() {
  try {
    // Step 1: Create test student if needed
    $student = \App\Models\RoleAccount::where('email', 'test.complete@spup.edu.ph')->first();

    if (!$student) {
      $student = \App\Models\RoleAccount::create([
        'fullname' => 'Complete Test Student',
        'email' => 'test.complete@spup.edu.ph',
        'password' => \Hash::make('student123'),
        'student_id' => 'COMPLETE-' . time(),
        'department' => 'SITE',
        'account_type' => 'student',
        'status' => 1,
        'course' => 'BSIT',
        'year_level' => '4th Year'
      ]);
    }

    // Step 2: Clear existing data
    \App\Models\NotifArchive::where('student_id', $student->student_id)->delete();
    \App\Models\GoodMoralApplication::where('student_id', $student->student_id)->delete();
    \App\Models\Receipt::where('reference_num', 'LIKE', 'COMPLETE-%')->delete();

    // Step 3: Create a complete application workflow
    $refNum = 'COMPLETE-' . time() . '-' . strtoupper(\Str::random(6));

    // Create the main application (this will show up in registrar dashboard)
    $application = \App\Models\GoodMoralApplication::create([
      'reference_number' => $refNum,
      'fullname' => $student->fullname,
      'student_id' => $student->student_id,
      'department' => $student->department,
      'status' => 'pending', // This is key for registrar to see it
      'number_of_copies' => '2',
      'reason' => ['Employment', 'Transfer'],
      'certificate_type' => 'good_moral',
      'gender' => 'male',
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT 4th Year',
      'last_semester_sy' => 'First Semester 2024-2025',
      'application_status' => null // Pending applications have null status
    ]);

    // Step 4: Create initial notification (Status 0 - submitted)
    $notification1 = \App\Models\NotifArchive::create([
      'student_id' => $student->student_id,
      'reference_number' => $refNum,
      'fullname' => $student->fullname,
      'status' => '0', // Application submitted
      'number_of_copies' => '2',
      'reason' => ['Employment', 'Transfer'],
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'gender' => 'male',
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT 4th Year',
      'last_semester_sy' => 'First Semester 2024-2025',
      'created_at' => now()->subMinutes(5)
    ]);

    // Step 5: Create additional test applications for registrar to see
    for ($i = 1; $i <= 3; $i++) {
      $testStudent = \App\Models\RoleAccount::create([
        'fullname' => "Test Student {$i}",
        'email' => "test.student{$i}@spup.edu.ph",
        'password' => \Hash::make('student123'),
        'student_id' => 'TEST-' . time() . '-' . $i,
        'department' => 'SITE',
        'account_type' => 'student',
        'status' => 1,
        'course' => 'BSIT',
        'year_level' => '3rd Year'
      ]);

      $testRefNum = 'TEST-APP-' . time() . '-' . $i;

      \App\Models\GoodMoralApplication::create([
        'reference_number' => $testRefNum,
        'fullname' => $testStudent->fullname,
        'student_id' => $testStudent->student_id,
        'department' => $testStudent->department,
        'status' => 'pending',
        'number_of_copies' => '1',
        'reason' => ['Employment'],
        'certificate_type' => 'good_moral',
        'gender' => 'male',
        'is_undergraduate' => true,
        'last_course_year_level' => 'BSIT 3rd Year',
        'last_semester_sy' => 'First Semester 2024-2025',
        'application_status' => null
      ]);

      // Create notification for each test student
      \App\Models\NotifArchive::create([
        'student_id' => $testStudent->student_id,
        'reference_number' => $testRefNum,
        'fullname' => $testStudent->fullname,
        'status' => '0',
        'number_of_copies' => '1',
        'reason' => ['Employment'],
        'department' => $testStudent->department,
        'certificate_type' => 'good_moral',
        'gender' => 'male',
        'is_undergraduate' => true,
        'last_course_year_level' => 'BSIT 3rd Year',
        'last_semester_sy' => 'First Semester 2024-2025',
        'created_at' => now()->subMinutes($i)
      ]);
    }

    // Step 6: Verify data was created
    $totalApplications = \App\Models\GoodMoralApplication::count();
    $pendingApplications = \App\Models\GoodMoralApplication::where('status', 'pending')->count();
    $totalNotifications = \App\Models\NotifArchive::count();
    $studentNotifications = \App\Models\NotifArchive::where('student_id', $student->student_id)->count();

    // Step 7: Clear caches
    \Artisan::call('route:clear');
    \Artisan::call('config:clear');

    return response()->json([
      'success' => true,
      'message' => 'ðŸŽ‰ COMPLETE FIX APPLIED SUCCESSFULLY!',
      'created_data' => [
        'main_student' => [
          'email' => $student->email,
          'student_id' => $student->student_id,
          'password' => 'student123'
        ],
        'main_application' => [
          'reference_number' => $refNum,
          'status' => 'pending'
        ],
        'test_applications_created' => 3,
        'total_applications_in_db' => $totalApplications,
        'pending_applications_for_registrar' => $pendingApplications,
        'total_notifications_in_db' => $totalNotifications,
        'student_notifications' => $studentNotifications
      ],
      'testing_instructions' => [
        'FOR STUDENT NOTIFICATIONS:',
        '1. Login as: test.complete@spup.edu.ph / student123',
        '2. Go to /dashboard - should see notification bell with count',
        '3. Click "Application Notifications" - should see notification with status message',
        '',
        'FOR REGISTRAR APPLICATIONS:',
        '1. Login as registrar account',
        '2. Go to /registrar/good-moral-application',
        '3. Should see ' . $pendingApplications . ' pending applications',
        '4. Should be able to approve/reject applications'
      ],
      'urls_to_test' => [
        'student_dashboard' => route('dashboard'),
        'student_notifications' => route('notification'),
        'registrar_applications' => route('registrar.goodMoralApplication')
      ]
    ]);

  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Fix failed: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ], 500);
  }
})->name('fix.all.notification.registrar.issues');

// SIMPLE TEST TO VERIFY NOTIFICATION VIEW IS WORKING
Route::get('/test-notification-display', function() {
  if (!auth()->check()) {
    return redirect()->route('login');
  }

  $user = auth()->user();

  if (!in_array($user->account_type, ['student', 'alumni'])) {
    return response()->json(['error' => 'Must be student or alumni']);
  }

  try {
    // Get notifications for current user
    $notifications = \App\Models\NotifArchive::where('student_id', $user->student_id)
      ->orderBy('created_at', 'desc')
      ->get();

    if ($notifications->isEmpty()) {
      return response()->json([
        'error' => 'No notifications found for this user',
        'user_info' => [
          'student_id' => $user->student_id,
          'email' => $user->email
        ],
        'solution' => 'Run /fix-all-notification-and-registrar-issues first to create test data'
      ]);
    }

    // Test if the notification view can be rendered
    $receipts = \App\Models\Receipt::whereIn('reference_num', $notifications->pluck('reference_number'))
      ->get()
      ->keyBy('reference_num');

    $rejectionDetails = [];

    // Return debug information
    return response()->json([
      'success' => true,
      'user_info' => [
        'student_id' => $user->student_id,
        'email' => $user->email,
        'fullname' => $user->fullname
      ],
      'notifications_found' => $notifications->count(),
      'receipts_found' => $receipts->count(),
      'notifications_detail' => $notifications->map(function($notif) {
        return [
          'id' => $notif->id,
          'reference_number' => $notif->reference_number,
          'status' => $notif->status,
          'formatted_reasons' => $notif->formatted_reasons,
          'payment_amount' => $notif->payment_amount,
          'created_at' => $notif->created_at->format('Y-m-d H:i:s')
        ];
      }),
      'next_steps' => [
        '1. Visit /notification to see if notifications display properly',
        '2. Check if status messages appear for each notification',
        '3. Verify payment forms show for status 2 notifications'
      ]
    ]);

  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Test failed: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ], 500);
  }
})->middleware(['auth', 'verified'])->name('test.notification.display');

// EMERGENCY FIX - REPLACE NOTIFICATION CONTROLLER METHOD TEMPORARILY
Route::get('/emergency-fix-notifications', function() {
  if (!auth()->check()) {
    return redirect()->route('login');
  }

  $user = auth()->user();

  if (!in_array($user->account_type, ['student', 'alumni'])) {
    return redirect()->route('dashboard')->with('error', 'Access denied');
  }

  try {
    // Step 1: Create test data if none exists
    $notifications = \App\Models\NotifArchive::where('student_id', $user->student_id)->get();

    if ($notifications->isEmpty()) {
      // Create emergency test notification
      $refNum = 'EMERGENCY-' . time();

      // Create application first
      \App\Models\GoodMoralApplication::create([
        'reference_number' => $refNum,
        'fullname' => $user->fullname,
        'student_id' => $user->student_id,
        'department' => $user->department ?? 'SITE',
        'status' => 'pending',
        'number_of_copies' => '1',
        'reason' => ['Employment'],
        'certificate_type' => 'good_moral',
        'gender' => 'male',
        'is_undergraduate' => true,
        'last_course_year_level' => 'BSIT',
        'last_semester_sy' => 'First Semester 2024-2025'
      ]);

      // Create notification
      \App\Models\NotifArchive::create([
        'student_id' => $user->student_id,
        'reference_number' => $refNum,
        'fullname' => $user->fullname,
        'status' => '0',
        'number_of_copies' => '1',
        'reason' => ['Employment'],
        'department' => $user->department ?? 'SITE',
        'certificate_type' => 'good_moral',
        'gender' => 'male',
        'is_undergraduate' => true,
        'last_course_year_level' => 'BSIT',
        'last_semester_sy' => 'First Semester 2024-2025'
      ]);

      $notifications = \App\Models\NotifArchive::where('student_id', $user->student_id)->get();
    }

    // Step 2: Get receipts
    $receipts = \App\Models\Receipt::whereIn('reference_num', $notifications->pluck('reference_number'))
      ->get()
      ->keyBy('reference_num');

    // Step 3: Get rejection details
    $rejectionDetails = [];

    // Step 4: Render the view directly with debug info
    $viewData = compact('notifications', 'receipts', 'rejectionDetails');

    return view('notification', $viewData);

  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Emergency fix failed: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ], 500);
  }
})->middleware(['auth', 'verified'])->name('emergency.fix.notifications');

// EMERGENCY FIX - REGISTRAR APPLICATIONS PAGE
Route::get('/emergency-fix-registrar', function() {
  if (!auth()->check()) {
    return redirect()->route('login');
  }

  $user = auth()->user();

  if ($user->account_type !== 'registrar') {
    return redirect()->route('dashboard')->with('error', 'Access denied - must be registrar');
  }

  try {
    // Step 1: Create test applications if none exist
    $pendingApps = \App\Models\GoodMoralApplication::where('status', 'pending')->get();

    if ($pendingApps->isEmpty()) {
      // Create test students and applications
      for ($i = 1; $i <= 3; $i++) {
        $testStudent = \App\Models\RoleAccount::create([
          'fullname' => "Emergency Test Student {$i}",
          'email' => "emergency.test{$i}@spup.edu.ph",
          'password' => \Hash::make('student123'),
          'student_id' => 'EMERGENCY-' . time() . '-' . $i,
          'department' => 'SITE',
          'account_type' => 'student',
          'status' => 1,
          'course' => 'BSIT',
          'year_level' => '4th Year'
        ]);

        $refNum = 'EMERGENCY-APP-' . time() . '-' . $i;

        \App\Models\GoodMoralApplication::create([
          'reference_number' => $refNum,
          'fullname' => $testStudent->fullname,
          'student_id' => $testStudent->student_id,
          'department' => $testStudent->department,
          'status' => 'pending', // This is key for registrar to see
          'number_of_copies' => '1',
          'reason' => ['Employment'],
          'certificate_type' => 'good_moral',
          'gender' => 'male',
          'is_undergraduate' => true,
          'last_course_year_level' => 'BSIT 4th Year',
          'last_semester_sy' => 'First Semester 2024-2025',
          'application_status' => null // Pending apps have null status
        ]);
      }
    }

    // Step 2: Get applications with student relationships
    $applications = \App\Models\GoodMoralApplication::with('student')
      ->where('status', 'pending')
      ->paginate(10);

    // Step 3: Count pending applications
    $pendingCount = \App\Models\GoodMoralApplication::where('status', 'pending')->count();

    // Step 4: Get recent processed applications
    $recentProcessed = \App\Models\GoodMoralApplication::with('student')
      ->whereIn('status', ['approved', 'rejected'])
      ->orderBy('updated_at', 'desc')
      ->limit(5)
      ->get();

    // Step 5: Render the registrar view directly
    return view('registrar.goodMoralApplication', compact('applications', 'pendingCount', 'recentProcessed'));

  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Emergency registrar fix failed: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString(),
      'user_info' => [
        'account_type' => $user->account_type,
        'email' => $user->email
      ]
    ], 500);
  }
})->middleware(['auth', 'verified'])->name('emergency.fix.registrar');

// ULTIMATE EMERGENCY FIX - BOTH ISSUES AT ONCE
Route::get('/ultimate-emergency-fix-everything', function() {
  try {
    // Step 1: Create test student
    $student = \App\Models\RoleAccount::where('email', 'ultimate.test@spup.edu.ph')->first();

    if (!$student) {
      $student = \App\Models\RoleAccount::create([
        'fullname' => 'Ultimate Test Student',
        'email' => 'ultimate.test@spup.edu.ph',
        'password' => \Hash::make('student123'),
        'student_id' => 'ULTIMATE-' . time(),
        'department' => 'SITE',
        'account_type' => 'student',
        'status' => 1,
        'course' => 'BSIT',
        'year_level' => '4th Year'
      ]);
    }

    // Step 2: Clear existing data
    \App\Models\NotifArchive::where('student_id', $student->student_id)->delete();
    \App\Models\GoodMoralApplication::where('student_id', $student->student_id)->delete();

    // Step 3: Create application and notification
    $refNum = 'ULTIMATE-FIX-' . time();

    $application = \App\Models\GoodMoralApplication::create([
      'reference_number' => $refNum,
      'fullname' => $student->fullname,
      'student_id' => $student->student_id,
      'department' => $student->department,
      'status' => 'pending',
      'number_of_copies' => '1',
      'reason' => ['Employment'],
      'certificate_type' => 'good_moral',
      'gender' => 'male',
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT 4th Year',
      'last_semester_sy' => 'First Semester 2024-2025'
    ]);

    $notification = \App\Models\NotifArchive::create([
      'student_id' => $student->student_id,
      'reference_number' => $refNum,
      'fullname' => $student->fullname,
      'status' => '0',
      'number_of_copies' => '1',
      'reason' => ['Employment'],
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'gender' => 'male',
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT 4th Year',
      'last_semester_sy' => 'First Semester 2024-2025'
    ]);

    // Step 4: Create additional test applications for registrar
    for ($i = 1; $i <= 2; $i++) {
      $testStudent = \App\Models\RoleAccount::create([
        'fullname' => "Ultimate Test Student {$i}",
        'email' => "ultimate.test{$i}@spup.edu.ph",
        'password' => \Hash::make('student123'),
        'student_id' => 'ULTIMATE-TEST-' . time() . '-' . $i,
        'department' => 'SITE',
        'account_type' => 'student',
        'status' => 1,
        'course' => 'BSIT',
        'year_level' => '3rd Year'
      ]);

      \App\Models\GoodMoralApplication::create([
        'reference_number' => 'ULTIMATE-APP-' . time() . '-' . $i,
        'fullname' => $testStudent->fullname,
        'student_id' => $testStudent->student_id,
        'department' => $testStudent->department,
        'status' => 'pending',
        'number_of_copies' => '1',
        'reason' => ['Employment'],
        'certificate_type' => 'good_moral',
        'gender' => 'male',
        'is_undergraduate' => true,
        'last_course_year_level' => 'BSIT 3rd Year',
        'last_semester_sy' => 'First Semester 2024-2025'
      ]);
    }

    // Step 5: Verify data
    $totalApps = \App\Models\GoodMoralApplication::count();
    $pendingApps = \App\Models\GoodMoralApplication::where('status', 'pending')->count();
    $totalNotifs = \App\Models\NotifArchive::count();

    return response()->json([
      'success' => true,
      'message' => 'ðŸŽ‰ ULTIMATE EMERGENCY FIX COMPLETED!',
      'data_created' => [
        'total_applications' => $totalApps,
        'pending_applications' => $pendingApps,
        'total_notifications' => $totalNotifs
      ],
      'test_accounts' => [
        'student' => [
          'email' => 'ultimate.test@spup.edu.ph',
          'password' => 'student123',
          'student_id' => $student->student_id
        ]
      ],
      'direct_test_urls' => [
        'student_notifications' => '/emergency-fix-notifications',
        'registrar_applications' => '/emergency-fix-registrar'
      ],
      'instructions' => [
        '1. For STUDENT NOTIFICATIONS:',
        '   - Login as: ultimate.test@spup.edu.ph / student123',
        '   - Visit: /emergency-fix-notifications',
        '   - Should see notification with status message',
        '',
        '2. For REGISTRAR APPLICATIONS:',
        '   - Login as registrar',
        '   - Visit: /emergency-fix-registrar',
        '   - Should see ' . $pendingApps . ' pending applications with approve/reject buttons'
      ]
    ]);

  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Ultimate fix failed: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ], 500);
  }
})->name('ultimate.emergency.fix.everything');

Route::get('/notification', [ApplicationController::class, 'notification'])
  ->middleware(['auth', 'verified'])
  ->name('notification');

// Receipt upload route
Route::post('/receipt/upload', [ApplicationController::class, 'uploadReceipt'])
  ->middleware(['auth', 'verified'])
  ->name('receipt.upload');

// File serving route for receipts and payment notices
Route::get('/files/serve/{path}', function($path) {
  $fullPath = storage_path('app/public/' . $path);

  if (!file_exists($fullPath)) {
    abort(404, 'File not found');
  }

  return response()->file($fullPath);
})->where('path', '.*')->middleware(['auth', 'verified'])->name('files.serve');

Route::get('/notificationViolation', [ApplicationController::class, 'notificationViolation'])
  ->middleware(['auth', 'verified'])
  ->name('notificationViolation');

// Student notification counts route
Route::get('/student/notification-counts', [ApplicationController::class, 'getNotificationCounts'])
  ->middleware(['auth', 'verified'])
  ->name('student.notification.counts');

// Test notification system (for debugging - remove in production)
Route::get('/test-notifications', function() {
  if (!Auth::check()) {
    return response()->json(['error' => 'Not authenticated']);
  }

  $user = Auth::user();
  $studentId = $user->student_id;

  // Count notifications
  $applicationNotifications = \App\Models\NotifArchive::where('student_id', $studentId)->count();
  $violationNotifications = \App\Models\ViolationNotif::where('student_id', $studentId)->where('status', 0)->count();

  return response()->json([
    'user' => [
      'id' => $user->id,
      'student_id' => $user->student_id,
      'account_type' => $user->account_type,
      'fullname' => $user->fullname
    ],
    'applicationNotifications' => $applicationNotifications,
    'violationNotifications' => $violationNotifications,
    'totalNotifications' => $applicationNotifications + $violationNotifications,
  ]);
})->middleware(['auth', 'verified'])->name('test.notifications');

// Create test notification data
Route::get('/create-test-notification', function() {
  if (!Auth::check()) {
    return response()->json(['error' => 'Not authenticated']);
  }

  $user = Auth::user();

  // Create a test application notification
  \App\Models\NotifArchive::create([
    'student_id' => $user->student_id,
    'reference_number' => 'TEST-' . time(),
    'fullname' => $user->fullname,
    'status' => '0',
    'number_of_copies' => '1',
    'reason' => ['Test Notification'],
    'department' => $user->department,
    'certificate_type' => 'good_moral'
  ]);

  return response()->json([
    'success' => true,
    'message' => 'Test notification created for ' . $user->fullname,
    'user_id' => $user->student_id
  ]);
})->middleware(['auth', 'verified'])->name('create.test.notification');

// Create test application workflow
Route::get('/create-test-application-workflow', function() {
  if (!Auth::check()) {
    return response()->json(['error' => 'Not authenticated']);
  }

  $user = Auth::user();
  $refNum = 'TEST-WORKFLOW-' . time();

  // Create application
  $application = \App\Models\GoodMoralApplication::create([
    'reference_number' => $refNum,
    'fullname' => $user->fullname,
    'student_id' => $user->student_id,
    'department' => $user->department,
    'status' => 'pending',
    'number_of_copies' => '1',
    'reason' => ['Test'],
    'certificate_type' => 'good_moral',
    'gender' => 'male',
    'is_undergraduate' => true,
    'last_course_year_level' => 'BSIT',
    'last_semester_sy' => 'First Semester 2024-2025'
  ]);

  // Create step-by-step notifications
  $steps = [
    ['status' => '0', 'description' => 'Application submitted - with registrar'],
    ['status' => '1', 'description' => 'Approved by registrar - with dean'],
    ['status' => '2', 'description' => 'Approved by dean - with administrator'],
    ['status' => '3', 'description' => 'Approved by administrator - payment required'],
    ['status' => '4', 'description' => 'Payment received - ready for printing'],
    ['status' => '5', 'description' => 'Certificate printed - ready for pickup']
  ];

  foreach ($steps as $step) {
    \App\Models\NotifArchive::create([
      'student_id' => $user->student_id,
      'reference_number' => $refNum,
      'fullname' => $user->fullname,
      'status' => $step['status'],
      'number_of_copies' => '1',
      'reason' => ['Test'],
      'department' => $user->department,
      'certificate_type' => 'good_moral',
      'gender' => 'male',
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025'
    ]);
  }

  return response()->json([
    'success' => true,
    'message' => 'Complete application workflow created with 6 steps',
    'reference_number' => $refNum,
    'steps_created' => count($steps)
  ]);
})->middleware(['auth', 'verified'])->name('create.test.workflow');

// Test all role notifications
Route::get('/test-all-notifications', function() {
  $results = [];

  // Test Student/Alumni notifications
  $students = \App\Models\RoleAccount::whereIn('account_type', ['student', 'alumni'])->take(1)->get();
  foreach ($students as $student) {
    $appCount = \App\Models\NotifArchive::where('student_id', $student->student_id)->count();
    $violCount = \App\Models\ViolationNotif::where('student_id', $student->student_id)->where('status', 0)->count();
    $results['student_' . $student->id] = [
      'name' => $student->fullname,
      'type' => $student->account_type,
      'application_notifications' => $appCount,
      'violation_notifications' => $violCount
    ];
  }

  // Test Registrar notifications
  $pendingApps = \App\Models\GoodMoralApplication::where('status', 'pending')->count();
  $results['registrar'] = [
    'pending_applications' => $pendingApps
  ];

  // Test Admin notifications
  $adminPending = \App\Models\GoodMoralApplication::where('application_status', 'LIKE', 'Approved by Dean:%')
    ->whereNotIn('application_status', ['Approved by Administrator', 'Rejected by Administrator'])
    ->count();
  $results['admin'] = [
    'pending_applications' => $adminPending
  ];

  // Test Dean notifications (for SITE department)
  $deanPending = \App\Models\GoodMoralApplication::where(function($query) {
      $query->where('application_status', 'LIKE', 'Approved By Registrar%')
            ->orWhere('application_status', 'LIKE', 'Approved by Registrar%');
    })
    ->where('department', 'SITE')
    ->count();
  $results['dean_site'] = [
    'pending_applications' => $deanPending
  ];

  return response()->json([
    'success' => true,
    'notification_counts' => $results,
    'timestamp' => now()->toDateTimeString()
  ]);
})->name('test.all.notifications');

// Test email authentication
Route::get('/test-email-auth', function() {
  $results = [];

  // Get sample users with different email formats
  $users = \App\Models\RoleAccount::whereIn('account_type', ['student', 'alumni'])
    ->take(5)
    ->get();

  foreach ($users as $user) {
    $results[] = [
      'id' => $user->id,
      'student_id' => $user->student_id,
      'fullname' => $user->fullname,
      'email' => $user->email,
      'email_lowercase' => strtolower($user->email),
      'account_type' => $user->account_type,
      'status' => $user->status,
      'department' => $user->department
    ];
  }

  return response()->json([
    'success' => true,
    'message' => 'Email authentication test data',
    'users' => $results,
    'total_students_alumni' => \App\Models\RoleAccount::whereIn('account_type', ['student', 'alumni'])->count(),
    'active_users' => \App\Models\RoleAccount::where('status', 1)->whereIn('account_type', ['student', 'alumni'])->count()
  ]);
})->name('test.email.auth');

// Check existing notifications
Route::get('/check-notifications', function() {
  $notifications = \App\Models\NotifArchive::orderBy('created_at', 'desc')->take(10)->get();
  $totalCount = \App\Models\NotifArchive::count();

  $result = [
    'total_notifications' => $totalCount,
    'recent_notifications' => $notifications->map(function($notif) {
      return [
        'id' => $notif->id,
        'student_id' => $notif->student_id,
        'reference_number' => $notif->reference_number,
        'status' => $notif->status,
        'created_at' => $notif->created_at->format('Y-m-d H:i:s'),
        'certificate_type' => $notif->certificate_type ?? 'N/A'
      ];
    })
  ];

  return response()->json($result);
})->name('check.notifications');

// Test student login and notifications
Route::get('/test-student-login', function() {
  // Find a student with notifications using the correct table
  $studentsWithNotifications = \App\Models\NotifArchive::select('student_id')
    ->distinct()
    ->pluck('student_id');

  $student = \App\Models\RoleAccount::whereIn('account_type', ['student', 'alumni'])
    ->whereIn('student_id', $studentsWithNotifications)
    ->first();

  if (!$student) {
    // Get any student if none with notifications
    $student = \App\Models\RoleAccount::where('account_type', 'student')->first();
    if (!$student) {
      return response()->json(['error' => 'No student accounts found']);
    }
  }

  // Get notification count for this student
  $notificationCount = \App\Models\NotifArchive::where('student_id', $student->student_id)->count();

  return response()->json([
    'student' => [
      'id' => $student->id,
      'student_id' => $student->student_id,
      'fullname' => $student->fullname,
      'email' => $student->email,
      'account_type' => $student->account_type
    ],
    'notification_count' => $notificationCount,
    'login_url' => route('login'),
    'dashboard_url' => route('dashboard'),
    'test_credentials' => [
      'email' => $student->email,
      'password' => 'student123' // Default password for imported students
    ]
  ]);
})->name('test.student.login');

// Check database tables
Route::get('/check-tables', function() {
  try {
    $tables = \DB::select('SHOW TABLES');
    $notificationTables = [];

    foreach($tables as $table) {
      $tableName = array_values((array)$table)[0];
      if(str_contains(strtolower($tableName), 'notif')) {
        $notificationTables[] = $tableName;
      }
    }

    $notifArchiveCount = \App\Models\NotifArchive::count();
    $violationNotifCount = \App\Models\ViolationNotif::count();

    return response()->json([
      'notification_tables' => $notificationTables,
      'notifarchive_count' => $notifArchiveCount,
      'violation_notif_count' => $violationNotifCount,
      'sample_notifications' => \App\Models\NotifArchive::take(3)->get(['id', 'student_id', 'reference_number', 'status', 'created_at'])
    ]);
  } catch (\Exception $e) {
    return response()->json(['error' => $e->getMessage()]);
  }
})->name('check.tables');

// Create test student with notifications
Route::get('/create-test-student-with-notifications', function() {
  try {
    // Create or find a test student
    $student = \App\Models\RoleAccount::where('email', 'test.student@spup.edu.ph')->first();

    if (!$student) {
      $student = \App\Models\RoleAccount::create([
        'fullname' => 'Test Student',
        'email' => 'test.student@spup.edu.ph',
        'password' => \Hash::make('student123'),
        'student_id' => 'TEST-2024-001',
        'department' => 'SITE',
        'account_type' => 'student',
        'status' => 1,
        'course' => 'BSIT',
        'year_level' => '4th Year'
      ]);
    }

    // Create test notifications for this student
    $refNum = 'TEST-NOTIF-' . time();

    // Step 1: Application submitted
    \App\Models\NotifArchive::create([
      'student_id' => $student->student_id,
      'reference_number' => $refNum,
      'fullname' => $student->fullname,
      'status' => '0',
      'number_of_copies' => '1',
      'reason' => ['Employment'],
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT 4th Year',
      'last_semester_sy' => 'First Semester 2024-2025'
    ]);

    // Step 2: Approved by registrar
    \App\Models\NotifArchive::create([
      'student_id' => $student->student_id,
      'reference_number' => $refNum,
      'fullname' => $student->fullname,
      'status' => '1',
      'number_of_copies' => '1',
      'reason' => ['Employment'],
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT 4th Year',
      'last_semester_sy' => 'First Semester 2024-2025'
    ]);

    // Step 3: Approved by dean
    \App\Models\NotifArchive::create([
      'student_id' => $student->student_id,
      'reference_number' => $refNum,
      'fullname' => $student->fullname,
      'status' => '3',
      'number_of_copies' => '1',
      'reason' => ['Employment'],
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT 4th Year',
      'last_semester_sy' => 'First Semester 2024-2025'
    ]);

    $notificationCount = \App\Models\NotifArchive::where('student_id', $student->student_id)->count();

    return response()->json([
      'success' => true,
      'message' => 'Test student created with notifications',
      'student' => [
        'id' => $student->id,
        'student_id' => $student->student_id,
        'fullname' => $student->fullname,
        'email' => $student->email
      ],
      'notification_count' => $notificationCount,
      'reference_number' => $refNum,
      'login_credentials' => [
        'email' => 'test.student@spup.edu.ph',
        'password' => 'student123'
      ],
      'next_steps' => [
        '1. Go to /login',
        '2. Login with the credentials above',
        '3. Check the dashboard for notification bells',
        '4. Click on "Application Notifications" to see the step-by-step updates'
      ]
    ]);
  } catch (\Exception $e) {
    return response()->json(['error' => $e->getMessage()]);
  }
})->name('create.test.student.notifications');

// Test notification API for specific student
Route::get('/test-notification-api/{studentId}', function($studentId) {
  try {
    $student = \App\Models\RoleAccount::where('student_id', $studentId)->first();

    if (!$student) {
      return response()->json(['error' => 'Student not found']);
    }

    // Count notifications like the actual API does
    $applicationNotifications = \App\Models\NotifArchive::where('student_id', $studentId)
      ->whereIn('status', ['0', '1', '2', '3', '4', '5', '-1', '-2', '-3'])
      ->count();

    $violationNotifications = \App\Models\ViolationNotif::where('student_id', $studentId)
      ->where('status', 0)
      ->count();

    $notifications = \App\Models\NotifArchive::where('student_id', $studentId)
      ->orderBy('created_at', 'desc')
      ->get(['id', 'reference_number', 'status', 'created_at']);

    return response()->json([
      'student' => [
        'student_id' => $student->student_id,
        'fullname' => $student->fullname,
        'email' => $student->email
      ],
      'applicationNotifications' => $applicationNotifications,
      'violationNotifications' => $violationNotifications,
      'totalNotifications' => $applicationNotifications + $violationNotifications,
      'notifications_detail' => $notifications,
      'api_url' => '/student/notification-counts'
    ]);
  } catch (\Exception $e) {
    return response()->json(['error' => $e->getMessage()]);
  }
})->name('test.notification.api');

// Debug current user notifications - DISABLED FOR PRODUCTION
// Route::get('/debug-my-notifications', function() {
//   if (!Auth::check()) {
//     return response()->json(['error' => 'Not authenticated']);
//   }

//   $user = Auth::user();
//   $studentId = $user->student_id;

//   // Get all notifications for this student
//   $notifications = \App\Models\NotifArchive::where('student_id', $studentId)
//     ->orderBy('created_at', 'desc')
//     ->get(['id', 'reference_number', 'status', 'created_at', 'fullname']);

//   // Get all applications for this student
//   $applications = \App\Models\GoodMoralApplication::where('student_id', $studentId)
//     ->orderBy('created_at', 'desc')
//     ->get(['id', 'reference_number', 'application_status', 'created_at', 'fullname']);

//   // Count notifications
//   $notificationCount = \App\Models\NotifArchive::where('student_id', $studentId)->count();

//   return response()->json([
//     'user_info' => [
//       'id' => $user->id,
//       'student_id' => $user->student_id,
//       'fullname' => $user->fullname,
//       'email' => $user->email,
//       'account_type' => $user->account_type
//     ],
//     'notification_count' => $notificationCount,
//     'notifications' => $notifications,
//     'applications' => $applications,
//     'debug_info' => [
//       'notifications_table_count' => \App\Models\NotifArchive::count(),
//       'applications_table_count' => \App\Models\GoodMoralApplication::count(),
//       'my_notifications_count' => $notificationCount,
//       'my_applications_count' => $applications->count()
//     ]
//   ]);
// })->middleware(['auth', 'verified'])->name('debug.my.notifications');

// Notification count routes for all roles
Route::get('/psg-officer/notification-counts', [ProfileController::class, 'getPsgOfficerNotificationCounts'])
  ->middleware(['auth', 'verified'])
  ->name('psg.officer.notification.counts');

Route::get('/sec-osa/notification-counts', [ProfileController::class, 'getSecOsaNotificationCounts'])
  ->middleware(['auth', 'verified'])
  ->name('sec.osa.notification.counts');

Route::get('/head-osa/notification-counts', [ProfileController::class, 'getHeadOsaNotificationCounts'])
  ->middleware(['auth', 'verified'])
  ->name('head.osa.notification.counts');

Route::get('/dean/notification-counts', [ProfileController::class, 'getDeanNotificationCounts'])
  ->middleware(['auth', 'verified'])
  ->name('dean.notification.counts');

Route::get('/registrar/notification-counts', [ProfileController::class, 'getRegistrarNotificationCounts'])
  ->middleware(['auth', 'verified'])
  ->name('registrar.notification.counts');

// Student profile routes
Route::get('/student/profile', [ApplicationController::class, 'profile'])
  ->middleware(['auth', 'verified'])
  ->name('student.profile');

Route::patch('/student/profile/password', [ApplicationController::class, 'updatePassword'])
  ->middleware(['auth', 'verified'])
  ->name('student.profile.password.update');

Route::patch('/student/profile/email', [ApplicationController::class, 'updateEmail'])
  ->middleware(['auth', 'verified'])
  ->name('student.profile.email.update');

Route::patch('/student/profile', [ApplicationController::class, 'updateProfile'])
  ->middleware(['auth', 'verified'])
  ->name('student.profile.update');

// Debug route for testing notifications - DISABLED FOR PRODUCTION
// Route::get('/debug/notifications', function() {
//   if (!Auth::check()) {
//     return response()->json(['error' => 'Not authenticated']);
//   }

//   $user = Auth::user();
//   $studentId = $user->student_id;

//   $applicationNotifs = \App\Models\NotifArchive::where('student_id', $studentId)->get();
//   $violationNotifs = \App\Models\ViolationNotif::where('student_id', $studentId)->get();

//   return response()->json([
//     'user' => [
//       'id' => $user->id,
//       'email' => $user->email,
//       'student_id' => $user->student_id,
//       'account_type' => $user->account_type,
//     ],
//     'application_notifications' => $applicationNotifs,
//     'violation_notifications' => $violationNotifs,
//     'counts' => [
//       'application_unread' => $applicationNotifs->where('status', 0)->count(),
//       'violation_unread' => $violationNotifs->where('status', 0)->count(),
//     ]
//   ]);
// })->middleware(['auth', 'verified'])->name('debug.notifications');

//admin route==================================================================================================================================================================
// Simple test route to check admin access and dashboard
Route::get('/admin/test', function() {
  if (!auth()->check()) {
    return response()->json(['error' => 'Not authenticated']);
  }

  $user = auth()->user();

  // Test if we can access the dashboard method
  try {
    $controller = new \App\Http\Controllers\AdminController();
    $dashboardResult = $controller->dashboard(request());

    return response()->json([
      'authenticated' => true,
      'user_id' => $user->id,
      'email' => $user->email,
      'account_type' => $user->account_type,
      'is_admin' => $user->account_type === 'admin',
      'admin_dashboard_route' => route('admin.dashboard'),
      'dashboard_method_works' => true,
      'dashboard_result_type' => get_class($dashboardResult),
      'is_view' => $dashboardResult instanceof \Illuminate\View\View,
      'view_name' => $dashboardResult instanceof \Illuminate\View\View ? $dashboardResult->getName() : null,
    ]);
  } catch (\Exception $e) {
    return response()->json([
      'authenticated' => true,
      'user_id' => $user->id,
      'email' => $user->email,
      'account_type' => $user->account_type,
      'is_admin' => $user->account_type === 'admin',
      'admin_dashboard_route' => route('admin.dashboard'),
      'dashboard_method_works' => false,
      'dashboard_error' => $e->getMessage(),
      'dashboard_trace' => $e->getTraceAsString(),
    ]);
  }
})->middleware(['auth', 'verified'])->name('admin.test');

Route::get('/admin/dashboard', [AdminController::class, 'dashboard'])
  ->middleware(['auth', 'verified'])
  ->name('admin.dashboard');

Route::get('/admin/notification-counts', [AdminController::class, 'getNotificationCounts'])
  ->middleware(['auth', 'verified'])
  ->name('admin.notificationCounts');


Route::get('/admin/Application', [AdminController::class, 'applicationDashboard'])
  ->middleware(['auth', 'verified'])
  ->name('admin.Application');

Route::patch('/admin/Application/{id}/approve', [AdminController::class, 'approveApplication'])
  ->middleware(['auth', 'verified'])
  ->name('admin.approveApplication');

Route::delete('/admin/Application/{id}/reject', [AdminController::class, 'rejectApplication'])
  ->middleware(['auth', 'verified'])
  ->name('admin.rejectApplication');



Route::get('/admin/ready-for-print', [AdminController::class, 'readyForPrintApplications'])
  ->middleware(['auth', 'verified'])
  ->name('admin.readyForPrintApplications');



Route::post('/admin/print-certificate/{id}', [AdminController::class, 'printCertificate'])
  ->middleware(['auth', 'verified'])
  ->name('admin.printCertificate');

Route::get('/admin/download-certificate/{id}', [AdminController::class, 'downloadCertificate'])
  ->middleware(['auth', 'verified'])
  ->name('admin.downloadCertificate');

// Admin Good Moral Application routes
Route::patch('/admin/good-moral/{id}/approve', [AdminController::class, 'approveGoodMoralApplication'])
  ->middleware(['auth', 'verified'])
  ->name('admin.approveGoodMoralApplication');

Route::patch('/admin/good-moral/{id}/reject', [AdminController::class, 'rejectGoodMoralApplication'])
  ->middleware(['auth', 'verified'])
  ->name('admin.rejectGoodMoralApplication');
Route::get('/admin/psgApplication', [AdminController::class, 'psgApplication'])
  ->middleware(['auth', 'verified'])
  ->name('admin.psgApplication');



Route::get('/admin/generate-violators-report', [AdminController::class, 'generateViolatorsReport'])
  ->middleware(['auth', 'verified'])
  ->name('admin.generateViolatorsReport');

Route::get('/admin/reports', [AdminController::class, 'reportsPage'])
  ->middleware(['auth', 'verified'])
  ->name('admin.reports');

Route::get('/admin/reports/history', [AdminController::class, 'reportsHistory'])
  ->middleware(['auth', 'verified'])
  ->name('admin.reports.history');

Route::post('/admin/generate-selected-report', [AdminController::class, 'generateSelectedReport'])
  ->middleware(['auth', 'verified'])
  ->name('admin.generateSelectedReport');

// Test route for violators report data
Route::get('/test-violators-report-data', function() {
  try {
    // Define departments
    $departments = ['SASTE', 'SBAHM', 'SITE', 'SNAHS'];
    $departmentsData = [];
    $totals = [
      'total_cases' => 0,
      'closed_cases' => 0,
      'pending_cases' => 0,
      'unique_violators' => 0,
      'total_population' => 0,
    ];

    // Calculate data for each department
    foreach ($departments as $dept) {
      // Total cases (all violations in department)
      $totalCases = \App\Models\StudentViolation::where('department', $dept)->count();

      // Closed cases (status = 2)
      $closedCases = \App\Models\StudentViolation::where('department', $dept)->where('status', 2)->count();

      // Pending cases (status != 2)
      $pendingCases = \App\Models\StudentViolation::where('department', $dept)->where('status', '!=', 2)->count();

      // Unique violators (distinct student_ids with violations)
      $uniqueViolators = \App\Models\StudentViolation::where('department', $dept)->distinct('student_id')->count();

      // Total population (all students in department)
      $totalPopulation = \App\Models\RoleAccount::where('department', $dept)
        ->whereIn('account_type', ['student', 'alumni'])
        ->count();

      // Calculate percentage
      $percentage = $totalPopulation > 0 ? round(($uniqueViolators / $totalPopulation) * 100, 2) : 0;

      $departmentsData[$dept] = [
        'total_cases' => $totalCases,
        'closed_cases' => $closedCases,
        'pending_cases' => $pendingCases,
        'unique_violators' => $uniqueViolators,
        'total_population' => $totalPopulation,
        'percentage' => $percentage,
      ];

      // Add to totals
      $totals['total_cases'] += $totalCases;
      $totals['closed_cases'] += $closedCases;
      $totals['pending_cases'] += $pendingCases;
      $totals['unique_violators'] += $uniqueViolators;
      $totals['total_population'] += $totalPopulation;
    }

    // Calculate overall percentage
    $totals['percentage'] = $totals['total_population'] > 0
      ? round(($totals['unique_violators'] / $totals['total_population']) * 100, 2)
      : 0;

    return response()->json([
      'success' => true,
      'departments_data' => $departmentsData,
      'totals' => $totals,
      'summary' => [
        'total_cases' => $totals['total_cases'],
        'total_closed' => $totals['closed_cases'],
        'total_pending' => $totals['pending_cases'],
        'total_violators' => $totals['unique_violators'],
      ]
    ]);
  } catch (\Exception $e) {
    return response()->json([
      'error' => $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ]);
  }
})->name('test.violators.report.data');

Route::patch('/admin/psgApplication/{student_id}/approve', [AdminController::class, 'approvepsg'])
  ->middleware(['auth', 'verified'])
  ->name('admin.approvepsg');

Route::delete('/admin/psgApplication/{student_id}/reject', [AdminController::class, 'rejectpsg'])
  ->middleware(['auth', 'verified'])
  ->name('admin.rejectpsg');

Route::patch('/admin/psgApplication/{student_id}/revoke', [AdminController::class, 'revokePsg'])
  ->middleware(['auth', 'verified'])
  ->name('admin.revokepsg');

Route::patch('/admin/psgApplication/{student_id}/reconsider', [AdminController::class, 'reconsiderPsg'])
  ->middleware(['auth', 'verified'])
  ->name('admin.reconsiderpsg');

Route::delete('/admin/Addviolation/{id}/delete', [AdminController::class, 'deleteViolation'])
  ->middleware(['auth', 'verified'])
  ->name('admin.deleteViolation');

Route::patch('/admin/violation/update/{id}', [AdminController::class, 'updateViolation'])
  ->middleware(['auth', 'verified'])
  ->name('admin.updateViolation');

Route::get('/admin/GMAApporvedByRegistrar', [AdminController::class, 'GMAApporvedByRegistrar'])
  ->middleware(['auth', 'verified'])
  ->name('admin.GMAApporvedByRegistrar');

Route::post('/admin/import-users', [AdminController::class, 'importUsers'])
  ->middleware(['auth', 'verified'])
  ->name('admin.importUsers');

// Account management routes
Route::get('/admin/account/{id}/edit', [AdminController::class, 'editAccount'])
  ->middleware(['auth', 'verified'])
  ->name('admin.editAccount');

Route::put('/admin/account/{id}/update', [AdminController::class, 'updateAccount'])
  ->middleware(['auth', 'verified'])
  ->name('admin.updateAccount');

Route::delete('/admin/account/{id}/delete', [AdminController::class, 'deleteAccount'])
  ->middleware(['auth', 'verified'])
  ->name('admin.deleteAccount');

Route::get('/admin/download-template', [AdminController::class, 'downloadTemplate'])
  ->middleware(['auth', 'verified'])
  ->name('admin.downloadTemplate');

Route::get('/admin/violation', [AdminController::class, 'violation'])
  ->middleware(['auth', 'verified'])
  ->name('admin.violation');

Route::get('/admin/violation/search', [AdminController::class, 'violationsearch'])
  ->middleware(['auth', 'verified'])
  ->name('admin.violationsearch');

Route::post('/admin/violation/{id}/close-case', [AdminController::class, 'closeCase'])
  ->middleware(['auth', 'verified'])
  ->name('violations.closeCase');

Route::post('/admin/violation/{id}/mark-downloaded', [AdminController::class, 'markDownloaded'])
  ->middleware(['auth', 'verified'])
  ->name('violations.markDownloaded');

Route::get('/admin/violation-details/{id}', [AdminController::class, 'getViolationDetails'])
  ->middleware(['auth', 'verified'])
  ->name('admin.violationDetails');

Route::post('/admin/notification/{id}/mark-read', [AdminController::class, 'markNotificationAsRead'])
  ->middleware(['auth', 'verified'])
  ->name('admin.markNotificationAsRead');

Route::patch('/admin/application/{id}/approve', [AdminController::class, 'approveGMA'])
  ->middleware(['auth', 'verified'])
  ->name('admin.approveGMA');

// Reject Head_OSA Application Route==================================================================================================================================================================
Route::delete('/admin/application/{id}/reject', [AdminController::class, 'rejectGMA'])
  ->middleware(['auth', 'verified'])
  ->name('admin.rejectGMA');


//Psg_Officer==================================================================================================================================================================
// PSG Officer Dashboard - Updated to use new PsgOfficerController
Route::get('/PsgOfficer/dashboard', [\App\Http\Controllers\PsgOfficerController::class, 'dashboard'])
  ->middleware(['auth', 'verified'])
  ->name('PsgOfficer.dashboard');

// PSG Officer Good Moral and Personal Features
Route::get('/PsgOfficer/good-moral-form', [\App\Http\Controllers\PsgOfficerController::class, 'showGoodMoralForm'])
  ->middleware(['auth', 'verified'])
  ->name('PsgOfficer.goodMoralForm');

Route::post('/PsgOfficer/apply-good-moral', [\App\Http\Controllers\PsgOfficerController::class, 'applyForGoodMoral'])
  ->middleware(['auth', 'verified'])
  ->name('PsgOfficer.applyGoodMoral');

Route::get('/PsgOfficer/personal-violations', [\App\Http\Controllers\PsgOfficerController::class, 'showPersonalViolations'])
  ->middleware(['auth', 'verified'])
  ->name('PsgOfficer.personalViolations');

Route::get('/PsgOfficer/applications', [\App\Http\Controllers\PsgOfficerController::class, 'showApplications'])
  ->middleware(['auth', 'verified'])
  ->name('PsgOfficer.applications');

// Test route for PSG Officer functionality
Route::get('/test-psg-officer-features', function() {
  try {
    // Check if PSG Officer controller methods are accessible
    $controller = new \App\Http\Controllers\PsgOfficerController();

    // Check if CourseHelper is working
    $courseHelper = \App\Helpers\CourseHelper::class;
    $coursesExist = class_exists($courseHelper);

    // Check if required models exist
    $modelsExist = [
      'GoodMoralApplication' => class_exists(\App\Models\GoodMoralApplication::class),
      'StudentViolation' => class_exists(\App\Models\StudentViolation::class),
      'RoleAccount' => class_exists(\App\Models\RoleAccount::class),
    ];

    // Check if routes are registered
    $routes = [
      'PsgOfficer.dashboard' => route('PsgOfficer.dashboard'),
      'PsgOfficer.goodMoralForm' => route('PsgOfficer.goodMoralForm'),
      'PsgOfficer.personalViolations' => route('PsgOfficer.personalViolations'),
      'PsgOfficer.applications' => route('PsgOfficer.applications'),
    ];

    return [
      'status' => 'success',
      'message' => 'PSG Officer functionality is properly configured',
      'controller_exists' => true,
      'course_helper_exists' => $coursesExist,
      'models_exist' => $modelsExist,
      'routes_registered' => $routes,
      'current_user' => auth()->check() ? [
        'id' => auth()->user()->id,
        'account_type' => auth()->user()->account_type,
        'email' => auth()->user()->email
      ] : 'Not authenticated'
    ];
  } catch (\Exception $e) {
    return [
      'status' => 'error',
      'message' => 'Error testing PSG Officer functionality: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('test.psg.officer.features');

Route::get('/admin/AddViolation', [AdminController::class, 'AddViolationDashboard'])
  ->middleware(['auth', 'verified'])
  ->name('admin.AddViolation');

Route::get('/admin/AddViolator', [AdminController::class, 'AddViolatorDashboard'])
  ->middleware(['auth', 'verified'])
  ->name('admin.AddViolator');

Route::get('/admin/escalation-notifications', [AdminController::class, 'escalationNotifications'])
  ->middleware(['auth', 'verified'])
  ->name('admin.escalationNotifications');

Route::post('/admin/trigger-escalation/{student_id}', [AdminController::class, 'triggerManualEscalation'])
  ->middleware(['auth', 'verified'])
  ->name('admin.triggerEscalation');

// Restored original route
Route::post('/admin/AddViolator', [AdminController::class, 'storeViolator'])
  ->middleware(['auth', 'verified'])
  ->name('admin.storeViolator');

// Multiple violators route
Route::get('/admin/AddMultipleViolators', [AdminController::class, 'addMultipleViolatorsForm'])
  ->middleware(['auth', 'verified'])
  ->name('admin.AddMultipleViolators');

Route::post('/admin/AddMultipleViolators', [AdminController::class, 'storeMultipleViolators'])
  ->middleware(['auth', 'verified'])
  ->name('admin.storeMultipleViolators');

// Debug route for testing multiple violators
Route::get('/test-multiple-violators-debug', function() {
  return [
    'message' => 'Multiple violators debug route working',
    'violations' => \App\Models\Violation::take(5)->get(),
    'students' => \App\Models\RoleAccount::where('account_type', 'student')->take(5)->get(),
    'route_exists' => route('admin.storeMultipleViolators'),
  ];
});

// Debug page for multiple violators
Route::get('/admin/debug-multiple-violators', function() {
  return view('admin.debug-multiple-violators');
})
->middleware(['auth', 'verified'])
->name('admin.debugMultipleViolators');

// Simple test page for multiple violators
Route::get('/admin/simple-multiple-violators', function() {
  return view('admin.simple-multiple-violators');
})
->middleware(['auth', 'verified'])
->name('admin.simpleMultipleViolators');







// API route for student search (for violator forms)
Route::get('/api/students/search', [AdminController::class, 'searchStudents'])
  ->middleware(['auth', 'verified'])
  ->name('api.students.search');
Route::get('/api/students/search', [AdminController::class, 'searchStudents'])
  ->middleware(['auth', 'verified'])
  ->name('api.students.search');



Route::get('/PsgOfficer/PsgAddViolation', [RegisterViolationController::class, 'ViolatorDashboard'])
  ->middleware(['auth', 'verified'])
  ->name('PsgOfficer.PsgAddViolation');


Route::get('/PsgOfficer/Violator', [RegisterViolationController::class, 'violator'])
  ->middleware(['auth', 'verified'])
  ->name('PsgOfficer.Violator');

Route::get('/PsgOfficer/PsgViolation', [RegisterViolationController::class, 'PsgViolation'])
  ->middleware(['auth', 'verified'])
  ->name('PsgOfficer.PsgViolation');

Route::get('/psg-officer/check-violations/{studentId}', [RegisterViolationController::class, 'checkStudentViolations'])
  ->middleware(['auth', 'verified'])
  ->name('PsgOfficer.checkViolations');

// POST route for PSG Officer violation submission
Route::post('/PsgOfficer/registerviolation', [RegisterViolationController::class, 'store'])
  ->middleware(['auth', 'verified'])
  ->name('psg.registerviolation');

// Registrar Good Moral Application Route==================================================================================================================================================================
Route::get('/registrar/good-moral-application', [RegistrarController::class, 'goodMoralApplication'])
  ->middleware(['auth', 'verified'])
  ->name('registrar.goodMoralApplication');

// Test route for authentication status
Route::get('/auth-test', function() {
  if (!auth()->check()) {
    return [
      'authenticated' => false,
      'message' => 'No user authenticated',
      'session_id' => session()->getId(),
      'auth_guard' => config('auth.defaults.guard')
    ];
  }

  $user = auth()->user();
  return [
    'authenticated' => true,
    'user_id' => $user->id,
    'email' => $user->email,
    'account_type' => $user->account_type,
    'status' => $user->status,
    'guard' => 'web (using RoleAccount model)',
    'session_id' => session()->getId()
  ];
})->name('auth.test');

// Test route to check registrar accounts
Route::get('/check-registrars', function() {
  $registrars = \App\Models\RoleAccount::where('account_type', 'registrar')->get();
  return [
    'total_registrars' => $registrars->count(),
    'registrars' => $registrars->map(function($user) {
      return [
        'id' => $user->id,
        'email' => $user->email,
        'fullname' => $user->fullname,
        'account_type' => $user->account_type,
        'status' => $user->status
      ];
    })
  ];
})->name('check.registrars');

// Test route to check what happens when accessing dashboard routes
Route::get('/test-dashboard-access', function() {
  try {
    $adminRoute = route('admin.dashboard');
    $registrarRoute = route('registrar.goodMoralApplication');
    $deanRoute = route('dean.dashboard');

    return [
      'routes_exist' => true,
      'admin_route' => $adminRoute,
      'registrar_route' => $registrarRoute,
      'dean_route' => $deanRoute,
      'current_user' => auth()->check() ? auth()->user()->toArray() : 'Not authenticated'
    ];
  } catch (\Exception $e) {
    return [
      'error' => $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('test.dashboard.access');

// Simple test route to check if basic routing works
Route::get('/simple-test', function() {
  return [
    'status' => 'success',
    'message' => 'Basic routing works',
    'timestamp' => now(),
    'auth_check' => auth()->check(),
    'session_id' => session()->getId()
  ];
})->name('simple.test');

// Emergency bypass route - completely independent
Route::get('/emergency-test', function() {
  return 'EMERGENCY TEST WORKS - Basic Laravel routing is functional';
});

// Test route to check applications and notifications
Route::get('/test-applications', function() {
  try {
    // Check current applications in the database
    $apps = \App\Models\GoodMoralApplication::all();
    $pending = \App\Models\GoodMoralApplication::where('status', 'pending')->get();

    // Check registrar notification count
    $registrarNotificationCount = \App\Models\GoodMoralApplication::where('status', 'pending')->count();

    // Check admin notification count
    $adminNotificationCount = \App\Models\GoodMoralApplication::where('application_status', 'LIKE', 'Approved by Dean:%')
      ->whereNotIn('application_status', ['Approved by Administrator', 'Rejected by Administrator'])
      ->count();

    return [
      'total_applications' => $apps->count(),
      'pending_applications' => $pending->count(),
      'registrar_notification_count' => $registrarNotificationCount,
      'admin_notification_count' => $adminNotificationCount,
      'applications' => $apps->map(function($app) {
        return [
          'id' => $app->id,
          'status' => $app->status,
          'application_status' => $app->application_status,
          'student_id' => $app->student_id,
          'certificate_type' => $app->certificate_type,
          'created_at' => $app->created_at,
        ];
      }),
      'pending_details' => $pending->map(function($app) {
        return [
          'id' => $app->id,
          'student_id' => $app->student_id,
          'certificate_type' => $app->certificate_type,
          'status' => $app->status,
        ];
      }),
    ];
  } catch (\Exception $e) {
    return [
      'error' => $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('test.applications');

// Test route to create a sample application
Route::get('/create-test-application', function() {
  try {
    // Find or create a test student
    $student = \App\Models\RoleAccount::where('account_type', 'student')->first();

    if (!$student) {
      // Create a test student if none exists
      $student = \App\Models\RoleAccount::create([
        'fullname' => 'Test Student',
        'student_id' => 'TEST001',
        'email' => 'test.student@spup.edu.ph',
        'password' => \Hash::make('password'),
        'department' => 'SITE',
        'account_type' => 'student',
        'status' => 1,
      ]);
    }

    // Create a test good moral application
    $referenceNumber = 'REF-TEST-' . time();
    $application = \App\Models\GoodMoralApplication::create([
      'number_of_copies' => '1',
      'reference_number' => $referenceNumber,
      'fullname' => $student->fullname,
      'gender' => 'male',
      'reason' => ['Employment'],
      'student_id' => $student->student_id,
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'status' => 'pending',
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025',
    ]);

    // Create notification archive
    \App\Models\NotifArchive::create([
      'number_of_copies' => '1',
      'reference_number' => $referenceNumber,
      'fullname' => $student->fullname,
      'gender' => 'male',
      'reason' => ['Employment'],
      'student_id' => $student->student_id,
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'status' => '0',
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025',
    ]);

    return [
      'success' => true,
      'message' => 'Test application created successfully!',
      'student' => $student->toArray(),
      'application' => $application->toArray(),
      'pending_count' => \App\Models\GoodMoralApplication::where('status', 'pending')->count(),
    ];
  } catch (\Exception $e) {
    return [
      'error' => $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('create.test.application');

// Comprehensive test route to debug the notification system
Route::get('/debug-notifications', function() {
  try {
    // 1. Check if there are any applications
    $allApps = \App\Models\GoodMoralApplication::all();
    $pendingApps = \App\Models\GoodMoralApplication::where('status', 'pending')->get();

    // 2. Test the registrar controller method directly
    $registrarController = new \App\Http\Controllers\RegistrarController();

    // 3. Check if students exist and have proper relationships
    $studentsWithApps = \App\Models\RoleAccount::whereHas('goodMoralApplications')->get();

    // 4. Test the notification counts
    $registrarNotificationCount = \App\Models\GoodMoralApplication::where('status', 'pending')->count();

    // 5. Test the relationship loading
    $appsWithStudents = \App\Models\GoodMoralApplication::with('student')->get();

    return [
      'debug_info' => [
        'total_applications' => $allApps->count(),
        'pending_applications' => $pendingApps->count(),
        'registrar_notification_count' => $registrarNotificationCount,
        'students_with_apps' => $studentsWithApps->count(),
        'apps_with_students_loaded' => $appsWithStudents->count(),
      ],
      'applications_details' => $allApps->map(function($app) {
        return [
          'id' => $app->id,
          'status' => $app->status,
          'student_id' => $app->student_id,
          'student_exists' => $app->student ? true : false,
          'student_name' => $app->student ? $app->student->fullname : 'NO STUDENT FOUND',
          'certificate_type' => $app->certificate_type,
          'created_at' => $app->created_at,
        ];
      }),
      'pending_details' => $pendingApps->map(function($app) {
        return [
          'id' => $app->id,
          'student_id' => $app->student_id,
          'student_exists' => $app->student ? true : false,
          'student_name' => $app->student ? $app->student->fullname : 'NO STUDENT FOUND',
          'status' => $app->status,
        ];
      }),
      'relationship_test' => $appsWithStudents->map(function($app) {
        return [
          'app_id' => $app->id,
          'student_loaded' => $app->relationLoaded('student'),
          'student_exists' => $app->student ? true : false,
          'student_data' => $app->student ? [
            'id' => $app->student->id,
            'student_id' => $app->student->student_id,
            'fullname' => $app->student->fullname,
            'department' => $app->student->department,
          ] : null,
        ];
      }),
    ];
  } catch (\Exception $e) {
    return [
      'error' => $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('debug.notifications');

// Test the complete application flow
Route::get('/test-complete-flow', function() {
  try {
    // Step 1: Clear any existing test data
    \App\Models\GoodMoralApplication::where('student_id', 'LIKE', 'TEST%')->delete();
    \App\Models\NotifArchive::where('student_id', 'LIKE', 'TEST%')->delete();
    \App\Models\RoleAccount::where('student_id', 'LIKE', 'TEST%')->delete();

    // Step 2: Create a test student
    $student = \App\Models\RoleAccount::create([
      'fullname' => 'Test Student Flow',
      'student_id' => 'TEST-FLOW-001',
      'email' => 'test.flow@spup.edu.ph',
      'password' => \Hash::make('password'),
      'department' => 'SITE',
      'account_type' => 'student',
      'status' => 1,
    ]);

    // Step 3: Create a good moral application (simulating student submission)
    $referenceNumber = 'REF-FLOW-' . time();
    $application = \App\Models\GoodMoralApplication::create([
      'number_of_copies' => '1',
      'reference_number' => $referenceNumber,
      'fullname' => $student->fullname,
      'gender' => 'male',
      'reason' => ['Employment'],
      'student_id' => $student->student_id,
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'status' => 'pending', // This should trigger registrar notification
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025',
    ]);

    // Step 4: Create notification archive
    $notification = \App\Models\NotifArchive::create([
      'number_of_copies' => '1',
      'reference_number' => $referenceNumber,
      'fullname' => $student->fullname,
      'gender' => 'male',
      'reason' => ['Employment'],
      'student_id' => $student->student_id,
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'status' => '0', // Pending notification
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025',
    ]);

    // Step 5: Test all notification counts
    $registrarCount = \App\Models\GoodMoralApplication::where('status', 'pending')->count();
    $adminCount = \App\Models\GoodMoralApplication::where('application_status', 'LIKE', 'Approved by Dean:%')
      ->whereNotIn('application_status', ['Approved by Administrator', 'Rejected by Administrator'])
      ->count();

    // Step 6: Test relationship loading
    $appWithStudent = \App\Models\GoodMoralApplication::with('student')->find($application->id);

    // Step 7: Test registrar controller method
    $registrarApps = \App\Models\GoodMoralApplication::with('student')->where('status', 'pending')->get();

    return [
      'success' => true,
      'message' => 'Complete flow test completed successfully!',
      'results' => [
        'student_created' => $student->toArray(),
        'application_created' => $application->toArray(),
        'notification_created' => $notification->toArray(),
        'registrar_notification_count' => $registrarCount,
        'admin_notification_count' => $adminCount,
        'relationship_test' => [
          'student_loaded' => $appWithStudent->relationLoaded('student'),
          'student_exists' => $appWithStudent->student ? true : false,
          'student_data' => $appWithStudent->student ? $appWithStudent->student->toArray() : null,
        ],
        'registrar_apps_count' => $registrarApps->count(),
        'registrar_apps_with_students' => $registrarApps->map(function($app) {
          return [
            'app_id' => $app->id,
            'student_loaded' => $app->relationLoaded('student'),
            'student_exists' => $app->student ? true : false,
            'student_name' => $app->student ? $app->student->fullname : 'NO STUDENT',
          ];
        }),
      ],
    ];
  } catch (\Exception $e) {
    return [
      'error' => $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('test.complete.flow');

// Test registrar interface directly
Route::get('/test-registrar-interface', function() {
  try {
    // Simulate what the registrar controller does
    $status = request()->get('status', 'pending');
    $perPage = 10;

    // Get applications based on status filter (same as RegistrarController)
    if ($status === 'all') {
      $applications = \App\Models\GoodMoralApplication::with('student')->paginate($perPage);
    } else {
      $applications = \App\Models\GoodMoralApplication::with('student')->where('status', $status)->paginate($perPage);
    }

    // Count pending applications for notification bell
    $pendingCount = \App\Models\GoodMoralApplication::where('status', 'pending')->count();

    // Get recent processed applications for the history list
    $recentProcessed = \App\Models\GoodMoralApplication::with('student')->whereIn('status', ['approved', 'rejected'])
      ->orderBy('updated_at', 'desc')
      ->limit(5)
      ->get();

    return [
      'success' => true,
      'registrar_interface_test' => [
        'status_filter' => $status,
        'applications_count' => $applications->count(),
        'pending_count' => $pendingCount,
        'recent_processed_count' => $recentProcessed->count(),
        'applications' => $applications->items(),
        'applications_with_students' => $applications->map(function($app) {
          return [
            'id' => $app->id,
            'status' => $app->status,
            'student_id' => $app->student_id,
            'student_loaded' => $app->relationLoaded('student'),
            'student_exists' => $app->student ? true : false,
            'student_data' => $app->student ? [
              'id' => $app->student->id,
              'student_id' => $app->student->student_id,
              'fullname' => $app->student->fullname,
              'department' => $app->student->department,
            ] : null,
            'certificate_type' => $app->certificate_type,
            'created_at' => $app->created_at,
          ];
        }),
      ],
    ];
  } catch (\Exception $e) {
    return [
      'error' => $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('test.registrar.interface');

// Test student notification system specifically
Route::get('/test-student-notifications', function() {
  try {
    // Step 1: Create or find a test student
    $student = \App\Models\RoleAccount::where('student_id', 'TEST-STUDENT-001')->first();

    if (!$student) {
      $student = \App\Models\RoleAccount::create([
        'fullname' => 'Test Student Notifications',
        'student_id' => 'TEST-STUDENT-001',
        'email' => 'test.student.notif@spup.edu.ph',
        'password' => \Hash::make('password'),
        'department' => 'SITE',
        'account_type' => 'student',
        'status' => 1,
      ]);
    }

    // Step 2: Create a test application
    $referenceNumber = 'REF-NOTIF-' . time();
    $application = \App\Models\GoodMoralApplication::create([
      'number_of_copies' => '1',
      'reference_number' => $referenceNumber,
      'fullname' => $student->fullname,
      'gender' => 'male',
      'reason' => ['Employment'],
      'student_id' => $student->student_id,
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'status' => 'pending',
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025',
    ]);

    // Step 3: Create notification archive (simulating what happens in ApplicationController)
    $notification = \App\Models\NotifArchive::create([
      'number_of_copies' => '1',
      'reference_number' => $referenceNumber,
      'fullname' => $student->fullname,
      'gender' => 'male',
      'reason' => ['Employment'],
      'student_id' => $student->student_id,
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'status' => '0', // Status 0 = with registrar for review
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025',
    ]);

    // Step 4: Test the notification query (simulating ApplicationController::notification)
    $studentNotifications = \App\Models\NotifArchive::where('student_id', $student->student_id)
      ->orderBy('created_at', 'desc')
      ->get();

    // Step 5: Test the notification count query (simulating ApplicationController::getNotificationCounts)
    $applicationNotificationCount = \App\Models\NotifArchive::where('student_id', $student->student_id)->count();

    // Step 6: Check all notifications in the system for this student
    $allNotificationsForStudent = \App\Models\NotifArchive::where('student_id', $student->student_id)->get();

    // Step 7: Check if there are any notifications with similar student_ids
    $similarStudentIds = \App\Models\NotifArchive::where('student_id', 'LIKE', '%TEST%')->get();

    return [
      'success' => true,
      'test_results' => [
        'student_created' => $student->toArray(),
        'application_created' => $application->toArray(),
        'notification_created' => $notification->toArray(),
        'student_notifications_count' => $studentNotifications->count(),
        'application_notification_count' => $applicationNotificationCount,
        'student_notifications' => $studentNotifications->toArray(),
        'all_notifications_for_student' => $allNotificationsForStudent->toArray(),
        'similar_student_ids' => $similarStudentIds->map(function($notif) {
          return [
            'id' => $notif->id,
            'student_id' => $notif->student_id,
            'reference_number' => $notif->reference_number,
            'status' => $notif->status,
            'created_at' => $notif->created_at,
          ];
        }),
        'query_test' => [
          'student_id_used' => $student->student_id,
          'notification_student_id' => $notification->student_id,
          'ids_match' => $student->student_id === $notification->student_id,
        ],
      ],
    ];
  } catch (\Exception $e) {
    return [
      'error' => $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('test.student.notifications');

// Test student login and notification access
Route::get('/test-student-login-notifications', function() {
  try {
    // Find the test student
    $student = \App\Models\RoleAccount::where('student_id', 'TEST-STUDENT-001')->first();

    if (!$student) {
      return ['error' => 'Test student not found. Run /test-student-notifications first.'];
    }

    // Simulate logging in as this student
    \Auth::login($student);

    // Test the ApplicationController notification method
    $controller = new \App\Http\Controllers\ApplicationController();

    // Test notification count method
    $notificationCountsResponse = $controller->getNotificationCounts();
    $notificationCounts = json_decode($notificationCountsResponse->getContent(), true);

    // Test the notification method (this would normally return a view)
    $notifications = \App\Models\NotifArchive::where('student_id', \Auth::user()->student_id)
      ->orderBy('created_at', 'desc')
      ->get();

    $receipts = \App\Models\Receipt::whereIn('reference_num', $notifications->pluck('reference_number'))
      ->get()
      ->keyBy('reference_num');

    // Check if the student can see their notifications
    $studentCanSeeNotifications = $notifications->count() > 0;

    // Logout after test
    \Auth::logout();

    return [
      'success' => true,
      'test_results' => [
        'student_logged_in' => $student->toArray(),
        'notification_counts' => $notificationCounts,
        'notifications_found' => $notifications->count(),
        'student_can_see_notifications' => $studentCanSeeNotifications,
        'notifications' => $notifications->map(function($notif) {
          return [
            'id' => $notif->id,
            'reference_number' => $notif->reference_number,
            'student_id' => $notif->student_id,
            'status' => $notif->status,
            'certificate_type' => $notif->certificate_type,
            'created_at' => $notif->created_at,
          ];
        }),
        'receipts_found' => $receipts->count(),
        'auth_test' => [
          'student_id_from_auth' => $student->student_id,
          'notifications_query_student_id' => $student->student_id,
          'query_matches' => true,
        ],
      ],
    ];
  } catch (\Exception $e) {
    // Make sure to logout even if there's an error
    \Auth::logout();
    return [
      'error' => $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('test.student.login.notifications');

// Final comprehensive test for student notifications
Route::get('/test-final-student-notifications', function() {
  try {
    // Step 1: Clean up any existing test data
    \App\Models\GoodMoralApplication::where('student_id', 'FINAL-TEST-001')->delete();
    \App\Models\NotifArchive::where('student_id', 'FINAL-TEST-001')->delete();
    \App\Models\RoleAccount::where('student_id', 'FINAL-TEST-001')->delete();

    // Step 2: Create a fresh test student
    $student = \App\Models\RoleAccount::create([
      'fullname' => 'Final Test Student',
      'student_id' => 'FINAL-TEST-001',
      'email' => 'final.test@spup.edu.ph',
      'password' => \Hash::make('password'),
      'department' => 'SITE',
      'account_type' => 'student',
      'status' => 1,
    ]);

    // Step 3: Simulate the exact application creation process from ApplicationController
    $referenceNumber = 'REF-FINAL-' . time();
    $selectedReason = ['Employment'];

    // Create application (exactly as in ApplicationController::applyForGoodMoralCertificate)
    $application = \App\Models\GoodMoralApplication::create([
      'number_of_copies' => '1',
      'reference_number' => $referenceNumber,
      'fullname' => $student->fullname,
      'gender' => 'male',
      'reason' => $selectedReason,
      'student_id' => $student->student_id,
      'department' => $student->department,
      'course_completed' => null,
      'graduation_date' => null,
      'application_status' => null,
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025',
      'certificate_type' => 'good_moral',
      'status' => 'pending',
    ]);

    // Create notification (exactly as in ApplicationController::applyForGoodMoralCertificate)
    $notification = \App\Models\NotifArchive::create([
      'number_of_copies' => '1',
      'reference_number' => $referenceNumber,
      'fullname' => $student->fullname,
      'gender' => 'male',
      'reason' => $selectedReason,
      'student_id' => $student->student_id,
      'department' => $student->department,
      'course_completed' => null,
      'graduation_date' => null,
      'application_status' => null,
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025',
      'certificate_type' => 'good_moral',
      'status' => '0',
    ]);

    // Step 4: Test student login and notification access
    \Auth::login($student);

    // Test notification query (exactly as in ApplicationController::notification)
    $notifications = \App\Models\NotifArchive::where('student_id', \Auth::user()->student_id)
      ->orderBy('created_at', 'desc')
      ->get();

    // Test notification counts (exactly as in ApplicationController::getNotificationCounts)
    $applicationNotifications = \App\Models\NotifArchive::where('student_id', \Auth::user()->student_id)->count();

    // Step 5: Test the actual controller methods
    $controller = new \App\Http\Controllers\ApplicationController();
    $notificationCountsResponse = $controller->getNotificationCounts();
    $notificationCounts = json_decode($notificationCountsResponse->getContent(), true);

    // Logout
    \Auth::logout();

    return [
      'success' => true,
      'final_test_results' => [
        'student_created' => [
          'id' => $student->id,
          'student_id' => $student->student_id,
          'fullname' => $student->fullname,
          'email' => $student->email,
        ],
        'application_created' => [
          'id' => $application->id,
          'reference_number' => $application->reference_number,
          'student_id' => $application->student_id,
          'status' => $application->status,
        ],
        'notification_created' => [
          'id' => $notification->id,
          'reference_number' => $notification->reference_number,
          'student_id' => $notification->student_id,
          'status' => $notification->status,
        ],
        'student_can_see_notifications' => $notifications->count() > 0,
        'notification_count_from_query' => $applicationNotifications,
        'notification_count_from_controller' => $notificationCounts['applicationNotifications'],
        'notifications_match' => $applicationNotifications === $notificationCounts['applicationNotifications'],
        'notifications_found' => $notifications->map(function($notif) {
          return [
            'id' => $notif->id,
            'reference_number' => $notif->reference_number,
            'status' => $notif->status,
            'certificate_type' => $notif->certificate_type,
            'formatted_reasons' => $notif->formatted_reasons,
          ];
        }),
        'database_verification' => [
          'notifarchive_count' => \App\Models\NotifArchive::where('student_id', 'FINAL-TEST-001')->count(),
          'application_count' => \App\Models\GoodMoralApplication::where('student_id', 'FINAL-TEST-001')->count(),
        ],
      ],
    ];
  } catch (\Exception $e) {
    \Auth::logout();
    return [
      'error' => $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('test.final.student.notifications');

// Test the complete application workflow with correct status progression
Route::get('/test-complete-workflow', function() {
  try {
    // Clean up any existing test data
    \App\Models\GoodMoralApplication::where('student_id', 'WORKFLOW-TEST-001')->delete();
    \App\Models\NotifArchive::where('student_id', 'WORKFLOW-TEST-001')->delete();
    \App\Models\Receipt::where('reference_num', 'LIKE', 'REF-WORKFLOW%')->delete();
    \App\Models\RoleAccount::where('student_id', 'WORKFLOW-TEST-001')->delete();

    // Create test student
    $student = \App\Models\RoleAccount::create([
      'fullname' => 'Workflow Test Student',
      'student_id' => 'WORKFLOW-TEST-001',
      'email' => 'workflow.test@spup.edu.ph',
      'password' => \Hash::make('password'),
      'department' => 'SITE',
      'account_type' => 'student',
      'status' => 1,
    ]);

    $referenceNumber = 'REF-WORKFLOW-' . time();

    // Step 1: Student submits application (Status 0)
    $application = \App\Models\GoodMoralApplication::create([
      'number_of_copies' => '1',
      'reference_number' => $referenceNumber,
      'fullname' => $student->fullname,
      'gender' => 'male',
      'reason' => ['Employment'],
      'student_id' => $student->student_id,
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'status' => 'pending',
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025',
    ]);

    $notification1 = \App\Models\NotifArchive::create([
      'number_of_copies' => '1',
      'reference_number' => $referenceNumber,
      'fullname' => $student->fullname,
      'gender' => 'male',
      'reason' => ['Employment'],
      'student_id' => $student->student_id,
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'status' => '0', // Step 1: Submitted, with registrar
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025',
    ]);

    // Step 2: Registrar approves (Status 1)
    $application->status = 'approved';
    $application->application_status = 'Approved By Registrar Test User';
    $application->save();

    $notification2 = \App\Models\NotifArchive::create([
      'number_of_copies' => '1',
      'reference_number' => $referenceNumber,
      'fullname' => $student->fullname,
      'gender' => 'male',
      'reason' => ['Employment'],
      'student_id' => $student->student_id,
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'status' => '1', // Step 2: Approved by registrar, with dean
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025',
    ]);

    // Step 3: Dean approves (Status 3)
    $application->application_status = 'Approved by Dean: Test Dean';
    $application->save();

    $notification3 = \App\Models\NotifArchive::create([
      'number_of_copies' => '1',
      'reference_number' => $referenceNumber,
      'fullname' => $student->fullname,
      'gender' => 'male',
      'reason' => ['Employment'],
      'student_id' => $student->student_id,
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'status' => '3', // Step 3: Approved by dean, with administrator
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025',
    ]);

    // Step 4: Administrator approves (Status 2)
    $application->application_status = 'Approved by Administrator';
    $application->save();

    $notification4 = \App\Models\NotifArchive::create([
      'number_of_copies' => '1',
      'reference_number' => $referenceNumber,
      'fullname' => $student->fullname,
      'gender' => 'male',
      'reason' => ['Employment'],
      'student_id' => $student->student_id,
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'status' => '2', // Step 4: Approved by admin, upload receipt
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025',
    ]);

    // Step 5: Student uploads receipt (Status 4)
    $receipt = \App\Models\Receipt::create([
      'reference_num' => $referenceNumber,
      'official_receipt_no' => 'OR-TEST-12345',
      'date_paid' => now()->format('Y-m-d'),
      'document_path' => 'test/receipt.pdf',
      'status' => 'uploaded',
      'payment_method' => 'Cash/Bank Payment',
    ]);

    $notification5 = \App\Models\NotifArchive::create([
      'number_of_copies' => '1',
      'reference_number' => $referenceNumber,
      'fullname' => $student->fullname,
      'gender' => 'male',
      'reason' => ['Employment'],
      'student_id' => $student->student_id,
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'status' => '4', // Step 5: Receipt uploaded, ready for printing
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025',
    ]);

    // Step 6: Certificate printed (Status 5)
    $application->application_status = 'Ready for Pickup';
    $application->save();

    $notification6 = \App\Models\NotifArchive::create([
      'number_of_copies' => '1',
      'reference_number' => $referenceNumber,
      'fullname' => $student->fullname,
      'gender' => 'male',
      'reason' => ['Employment'],
      'student_id' => $student->student_id,
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'status' => '5', // Step 6: Certificate printed, ready for pickup
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT',
      'last_semester_sy' => 'First Semester 2024-2025',
    ]);

    // Test student login and view all notifications
    \Auth::login($student);
    $allNotifications = \App\Models\NotifArchive::where('student_id', $student->student_id)
      ->orderBy('created_at', 'desc')
      ->get();
    \Auth::logout();

    return [
      'success' => true,
      'complete_workflow_test' => [
        'student_created' => $student->toArray(),
        'application_final_status' => $application->application_status,
        'total_notifications' => $allNotifications->count(),
        'workflow_steps' => [
          'step_1_submit' => [
            'status' => '0',
            'message' => 'Step 1 of 6: Your application has been submitted successfully and is now with the Registrar for review & approval.',
            'notification_id' => $notification1->id,
          ],
          'step_2_registrar' => [
            'status' => '1',
            'message' => 'Step 2 of 6: Your application has been approved by the Registrar and forwarded to the Dean for review & approval.',
            'notification_id' => $notification2->id,
          ],
          'step_3_dean' => [
            'status' => '3',
            'message' => 'Step 3 of 6: Your application has been approved by the Dean and forwarded to the Administrator for final approval.',
            'notification_id' => $notification3->id,
          ],
          'step_4_admin' => [
            'status' => '2',
            'message' => 'Step 4 of 6: Your application has been approved by the Administrator. Please upload your payment receipt to proceed to certificate printing.',
            'notification_id' => $notification4->id,
          ],
          'step_5_receipt' => [
            'status' => '4',
            'message' => 'Step 5 of 6: Your payment receipt has been verified. Your certificate is now ready for printing & pickup.',
            'notification_id' => $notification5->id,
          ],
          'step_6_pickup' => [
            'status' => '5',
            'message' => 'Step 6 of 6: Your Good Moral Certificate has been printed and is ready for pickup at the Registrar\'s Office.',
            'notification_id' => $notification6->id,
          ],
        ],
        'all_notifications' => $allNotifications->map(function($notif) {
          return [
            'id' => $notif->id,
            'status' => $notif->status,
            'certificate_type' => $notif->certificate_type,
            'created_at' => $notif->created_at,
          ];
        }),
      ],
    ];
  } catch (\Exception $e) {
    \Auth::logout();
    return [
      'error' => $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('test.complete.workflow');

// Test login route directly
Route::get('/test-login', function() {
  try {
    return view('auth.login');
  } catch (\Exception $e) {
    return 'Login view error: ' . $e->getMessage();
  }
});

// Test CourseHelper functionality (for debugging)
Route::get('/test-course-helper', function() {
  try {
    $coursesByDepartment = \App\Helpers\CourseHelper::getCoursesByDepartment();
    $allCourses = \App\Helpers\CourseHelper::getAllCourses();
    $departments = \App\Helpers\CourseHelper::getAllDepartments();

    return response()->json([
      'courses_by_department' => $coursesByDepartment,
      'all_courses' => $allCourses,
      'departments' => $departments,
      'courses_count' => \App\Models\Course::count(),
      'active_courses_count' => \App\Models\Course::active()->count(),
    ], 200, [], JSON_PRETTY_PRINT);
  } catch (\Exception $e) {
    return response()->json([
      'error' => $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ], 500, [], JSON_PRETTY_PRINT);
  }
})->name('test.course.helper');





// Approve Application Route==================================================================================================================================================================
Route::patch('/registrar/application/{id}/approve', [RegistrarController::class, 'approve'])
  ->middleware(['auth', 'verified'])
  ->name('registrar.approve');


// Reject Application Route
Route::patch('/registrar/reject/{id}', [RegistrarController::class, 'reject'])
  ->middleware(['auth', 'verified'])
  ->name('registrar.reject');

// Reconsider Application Route
Route::patch('/registrar/reconsider/{id}', [RegistrarController::class, 'reconsider'])
  ->middleware(['auth', 'verified'])
  ->name('registrar.reconsider');

// Get Application Details Route
Route::get('/registrar/application/{id}/details', [RegistrarController::class, 'getApplicationDetails'])
  ->middleware(['auth', 'verified'])
  ->name('registrar.application.details');

// Registrar Notification Counts Route
Route::get('/registrar/notification-counts', [RegistrarController::class, 'getNotificationCounts'])
  ->middleware(['auth', 'verified'])
  ->name('registrar.notificationCounts');
// ============================================================================================== =================================================================================//

// Head_OSA Dashboard Route==================================================================================================================================================================
Route::get('/head_osa/dashboard', [HeadOSAController::class, 'dashboard'])
  ->middleware(['auth', 'verified'])
  ->name('head_osa.dashboard');

// Approve Head_OSA Application Route==================================================================================================================================================================
Route::patch('/head_osa/application/{id}/approve', [HeadOSAController::class, 'approve'])
  ->middleware(['auth', 'verified'])
  ->name('head_osa.approve');

// Reject Head_OSA Application Route==================================================================================================================================================================
Route::delete('/head_osa/application/{id}/reject', [HeadOSAController::class, 'reject'])
  ->middleware(['auth', 'verified'])
  ->name('head_osa.reject');

// Sec_OSA Dashboard Route==================================================================================================================================================================
Route::get('/sec_osa/dashboard', [SecOSAController::class, 'dashboard'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.dashboard');

// Sec_OSA Application Route==================================================================================================================================================================
Route::get('/sec_osa/application', [SecOSAController::class, 'application'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.application');

// Approve Sec_OSA Application Route==================================================================================================================================================================
Route::patch('/application/{id}/approve', [SecOSAController::class, 'approve'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.approve');


// Reject Sec_OSA Application Route==================================================================================================================================================================
Route::delete('/sec_osa/application/{id}/reject', [SecOSAController::class, 'reject'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.reject');

Route::get('/sec_osa/minor', [SecOSAController::class, 'minor'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.minor');

Route::get('/sec_osa/major', [SecOSAController::class, 'major'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.major');

Route::get('/sec_osa/escalation-notifications', [SecOSAController::class, 'escalationNotifications'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.escalationNotifications');
  
Route::get('/sec_osa/notification-counts', [SecOSAController::class, 'getNotificationCounts'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.notificationCounts');

Route::post('/sec_osa/upload/{id}', [SecOSAController::class, 'uploadDocument'])
  ->name('sec_osa.document');

Route::post('/sec_osa/major/{id}/forward-to-admin', [SecOSAController::class, 'forwardToAdmin'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.forwardToAdmin');

Route::post('/moderator/print-certificate/{id}', [SecOSAController::class, 'printCertificate'])
  ->middleware(['auth', 'verified'])
  ->name('moderator.printCertificate');

Route::get('/moderator/download-certificate/{id}', [SecOSAController::class, 'downloadCertificate'])
  ->middleware(['auth', 'verified'])
  ->name('moderator.downloadCertificate');

Route::get('/sec_osa/department/{department}/violations', [SecOSAController::class, 'viewDepartmentViolations'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.viewDepartmentViolations');

Route::get('/sec_osa/violations', [SecOSAController::class, 'violation'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.violation');

// Updated profile route with auth middleware only (no role check)
Route::get('/sec_osa/profile', [SecOSAController::class, 'profile'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.profile');

// Profile update routes
Route::patch('/sec_osa/profile', [SecOSAController::class, 'updateProfile'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.profile.update');

Route::patch('/sec_osa/profile/email', [SecOSAController::class, 'updateEmail'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.profile.email.update');

Route::patch('/sec_osa/profile/password', [SecOSAController::class, 'updatePassword'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.profile.password.update');

// Test route for moderator profile access
Route::get('/check-account-type', function() {
  if (!auth()->check()) {
    return "Not logged in";
  }
  
  $user = auth()->user();
  return "Current user: " . $user->fullname . ", Account Type: " . $user->account_type;
})->name('check.account.type');

Route::get('/moderator-profile-test', function() {
  if (!auth()->check()) {
    return redirect()->route('login');
  }
  
  $user = auth()->user();
  
  if ($user->account_type !== 'sec_osa') {
    return response()->json([
      'error' => 'Access denied',
      'user' => [
        'account_type' => $user->account_type,
        'required_type' => 'sec_osa'
      ]
    ], 403);
  }
  
  return view('sec_osa.profile', compact('user'));
})->name('moderator.profile.test');

// Test route for PDF generation
Route::get('/test-pdf', function() {
  try {
    // Create test data
    $testData = [
      'title' => 'Test Certificate',
      'application' => (object)[
        'fullname' => 'John Doe',
        'department' => 'SITE',
        'reason' => 'Testing purposes',
        'certificate_type' => 'good_moral'
      ],
      'studentDetails' => (object)[
        'year_level' => 'BSIT',
        'account_type' => 'student'
      ],
      'studentDetails1' => (object)[
        'last_semester_sy' => '2023-2024'
      ],
      'printed_by' => 'Test Moderator',
      'print_date' => now()->format('F j, Y')
    ];

    $pdf = \Barryvdh\DomPDF\Facade\Pdf::loadView('pdf.student_certificate', $testData);
    $pdf->setPaper('letter', 'portrait');

    return $pdf->download('test_certificate.pdf');
  } catch (\Exception $e) {
    return response()->json([
      'error' => $e->getMessage(),
      'file' => $e->getFile(),
      'line' => $e->getLine()
    ]);
  }
})->name('test.pdf');

// Test route for Residency Certificate
Route::get('/test-residency-pdf', function() {
  try {
    $testData = [
      'title' => 'Certificate of Residency',
      'application' => (object)[
        'fullname' => 'Test Alumni',
        'department' => 'SBAHM',
        'reason' => 'Employment purposes',
        'course_completed' => 'Bachelor of Science in Accountancy',
        'graduation_date' => '2025-06-02',
        'last_semester_sy' => 'Second Semester 2024-2025'
      ],
      'receipt' => (object)['document_path' => 'test_residency.pdf'],
      'printed_by' => 'Test Moderator',
      'studentDetails' => (object)['year_level' => null],
      'studentDetails1' => (object)['last_semester_sy' => 'Second Semester 2024-2025'],
      'print_date' => now()->format('F j, Y'),
    ];

    $pdf = \Barryvdh\DomPDF\Facade\Pdf::loadView('pdf.other_certificate', $testData);
    $pdf->setPaper('letter', 'portrait');

    return $pdf->download('test_residency_certificate.pdf');
  } catch (\Exception $e) {
    return response()->json([
      'error' => $e->getMessage(),
      'file' => $e->getFile(),
      'line' => $e->getLine()
    ]);
  }
})->name('test.residency.pdf');

// Test wkhtmltopdf route - Updated with new structure
Route::get('/test-wkhtmltopdf', function() {
  try {
    // Test data
    $testData = [
      'academic_year' => '2023-2024',
      'generated_date' => now()->format('F j, Y'),
      'applications' => collect([
        (object)[
          'created_at' => now(),
          'fullname' => 'DELA CRUZ, JUAN MIGUEL',
          'student_id' => 'TEST001',
          'reason' => 'Employment',
          'course' => 'BSIT',
          'last_semester_sy' => 'First Semester 2023-2024'
        ],
        (object)[
          'created_at' => now()->subDays(1),
          'fullname' => 'SANTOS, MARIA CLARA',
          'student_id' => 'TEST002',
          'reason' => 'Scholarship Application',
          'course' => 'BSN',
          'last_semester_sy' => 'Second Semester 2023-2024'
        ]
      ])
    ];

    // Test the updated wkhtmltopdf structure (following minor violations report pattern)
    $pdf = \Barryvdh\DomPDF\Facade\Pdf::loadView('pdf.wkhtmltopdf.good_moral_applicants_report', $testData);
    $pdf->setPaper('letter', 'portrait');

    return $pdf->download('test_good_moral_updated.pdf');

  } catch (\Exception $e) {
    return response()->json([
      'error' => $e->getMessage(),
      'file' => $e->getFile(),
      'line' => $e->getLine(),
      'trace' => $e->getTraceAsString()
    ]);
  }
})->name('test.wkhtmltopdf');

// Test residency report with new structure
Route::get('/test-residency-wkhtmltopdf', function() {
  try {
    // Test data
    $testData = [
      'academic_year' => '2023-2024',
      'generated_date' => now()->format('F j, Y'),
      'applications' => collect([
        (object)[
          'created_at' => now(),
          'fullname' => 'GARCIA, ANA MARIE',
          'student_id' => 'TEST003',
          'reason' => 'Visa Application',
          'course' => 'BSBA',
          'last_semester_sy' => 'First Semester 2023-2024'
        ]
      ])
    ];

    // Test the updated residency report structure
    $pdf = \Barryvdh\DomPDF\Facade\Pdf::loadView('pdf.wkhtmltopdf.residency_applicants_report', $testData);
    $pdf->setPaper('letter', 'portrait');

    return $pdf->download('test_residency_updated.pdf');

  } catch (\Exception $e) {
    return response()->json([
      'error' => $e->getMessage(),
      'file' => $e->getFile(),
      'line' => $e->getLine(),
      'trace' => $e->getTraceAsString()
    ]);
  }
})->name('test.residency.wkhtmltopdf');

// Test minor violations report (our reference that works)
Route::get('/test-minor-violations', function() {
  try {
    // Test data similar to minor violations report
    $testData = [
      'report_title' => 'MINOR VIOLATIONS REPORT',
      'academic_year' => '2023-2024',
      'generated_date' => now()->format('F j, Y'),
      'generated_time' => now()->format('g:i A'),
      'generated_by' => 'Test Admin',
      'total_count' => 2,
      'unique_violators' => 2,
      'departments_summary' => [
        'SITE' => 1,
        'SNAHS' => 1
      ],
      'violations' => collect([
        (object)[
          'student_id' => 'TEST001',
          'first_name' => 'JUAN',
          'last_name' => 'DELA CRUZ',
          'department' => 'SITE',
          'course' => 'BSIT',
          'violation' => 'Late submission',
          'created_at' => now(),
          'status' => 1
        ],
        (object)[
          'student_id' => 'TEST002',
          'first_name' => 'MARIA',
          'last_name' => 'SANTOS',
          'department' => 'SNAHS',
          'course' => 'BSN',
          'violation' => 'Dress code violation',
          'created_at' => now()->subDays(1),
          'status' => 2
        ]
      ])
    ];

    // Test the working minor violations report structure
    $pdf = \Barryvdh\DomPDF\Facade\Pdf::loadView('pdf.minor_violators_report', $testData);
    $pdf->setPaper('letter', 'portrait');

    return $pdf->download('test_minor_violations_reference.pdf');

  } catch (\Exception $e) {
    return response()->json([
      'error' => $e->getMessage(),
      'file' => $e->getFile(),
      'line' => $e->getLine(),
      'trace' => $e->getTraceAsString()
    ]);
  }
})->name('test.minor.violations');

// Debug route to test admin dashboard access
Route::get('/debug-admin-dashboard', function() {
  try {
    // Check if user is authenticated and is admin
    if (!auth()->check()) {
      return response()->json(['error' => 'Not authenticated']);
    }

    $user = auth()->user();
    if ($user->account_type !== 'admin') {
      return response()->json(['error' => 'Not admin user', 'account_type' => $user->account_type]);
    }

    // Try to call the dashboard method directly
    $controller = new \App\Http\Controllers\AdminController();
    $request = request();

    // Check if the dashboard method exists and is callable
    if (!method_exists($controller, 'dashboard')) {
      return response()->json(['error' => 'Dashboard method does not exist']);
    }

    // Try to call the dashboard method
    $result = $controller->dashboard($request);

    return response()->json([
      'success' => true,
      'result_type' => get_class($result),
      'is_view' => $result instanceof \Illuminate\View\View,
      'is_response' => $result instanceof \Illuminate\Http\Response,
      'view_name' => $result instanceof \Illuminate\View\View ? $result->getName() : null,
      'admin_route' => route('admin.dashboard'),
    ]);

  } catch (\Exception $e) {
    return response()->json([
      'error' => $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ]);
  }
})->middleware(['auth', 'verified'])->name('debug.admin.dashboard');

// Debug route to test email functionality
Route::get('/test-email', function() {
  try {
    // Test basic email sending
    $testEmail = 'test@example.com'; // Change this to your email

    // Send a test email
    \Illuminate\Support\Facades\Mail::raw('This is a test email from your Good Moral Application System.', function ($message) use ($testEmail) {
      $message->to($testEmail)
              ->subject('Test Email - Good Moral Application System')
              ->from(config('mail.from.address'), config('mail.from.name'));
    });

    return response()->json([
      'success' => true,
      'message' => 'Test email sent successfully!',
      'mail_config' => [
        'mailer' => config('mail.default'),
        'host' => config('mail.mailers.smtp.host'),
        'port' => config('mail.mailers.smtp.port'),
        'from_address' => config('mail.from.address'),
        'from_name' => config('mail.from.name'),
      ]
    ]);
  } catch (\Exception $e) {
    return response()->json([
      'success' => false,
      'error' => $e->getMessage(),
      'mail_config' => [
        'mailer' => config('mail.default'),
        'host' => config('mail.mailers.smtp.host'),
        'port' => config('mail.mailers.smtp.port'),
        'from_address' => config('mail.from.address'),
        'from_name' => config('mail.from.name'),
      ]
    ], 500);
  }
})->name('test.email');

// Test password reset email specifically
Route::get('/test-password-reset-email/{email}', function($email) {
  try {
    // Find user by email
    $user = \App\Models\RoleAccount::where('email', $email)->first();

    if (!$user) {
      return response()->json([
        'success' => false,
        'error' => 'User not found with email: ' . $email
      ]);
    }

    // Send password reset notification
    $status = \Illuminate\Support\Facades\Password::sendResetLink(['email' => $email]);

    return response()->json([
      'success' => $status === \Illuminate\Support\Facades\Password::RESET_LINK_SENT,
      'status' => $status,
      'message' => __($status),
      'user_found' => true,
      'user_email' => $user->email,
      'user_name' => $user->fullname,
    ]);
  } catch (\Exception $e) {
    return response()->json([
      'success' => false,
      'error' => $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ]);
  }
})->name('test.password.reset.email');

// Create test student for password reset testing
Route::get('/create-test-student', function() {
  try {
    // Create or update test student
    $student = \App\Models\RoleAccount::updateOrCreate(
      ['email' => 'test.student@example.com'],
      [
        'fullname' => 'Test Student',
        'student_id' => 'TEST-2024-001',
        'department' => 'SITE',
        'account_type' => 'student',
        'status' => '1',
        'password' => \Illuminate\Support\Facades\Hash::make('password123'),
        'email_verified_at' => now(),
      ]
    );

    return response()->json([
      'success' => true,
      'message' => 'Test student created/updated successfully!',
      'student' => [
        'email' => $student->email,
        'name' => $student->fullname,
        'student_id' => $student->student_id,
        'password' => 'password123 (for testing)',
      ],
      'test_links' => [
        'test_password_reset' => url('/test-password-reset-email/' . $student->email),
        'forgot_password_page' => route('password.request'),
      ]
    ]);
  } catch (\Exception $e) {
    return response()->json([
      'success' => false,
      'error' => $e->getMessage()
    ]);
  }
})->name('create.test.student');

// Debug route to test password reset functionality
Route::get('/debug-password-reset', function() {
  try {
    // Check if password reset system is properly configured
    $students = \App\Models\RoleAccount::where('account_type', 'student')->take(3)->get();
    $alumni = \App\Models\RoleAccount::where('account_type', 'alumni')->take(3)->get();

    $result = [
      'password_reset_config' => [
        'provider' => config('auth.passwords.users.provider'),
        'table' => config('auth.passwords.users.table'),
        'expire_minutes' => config('auth.passwords.users.expire'),
        'throttle_seconds' => config('auth.passwords.users.throttle'),
      ],
      'auth_provider' => [
        'driver' => config('auth.providers.users.driver'),
        'model' => config('auth.providers.users.model'),
      ],
      'sample_accounts' => [
        'students' => $students->map(function($student) {
          return [
            'email' => $student->email,
            'student_id' => $student->student_id,
            'fullname' => $student->fullname,
            'can_reset_password' => method_exists($student, 'sendPasswordResetNotification'),
            'implements_canresetpassword' => in_array('Illuminate\Auth\Passwords\CanResetPassword', class_uses($student)),
          ];
        }),
        'alumni' => $alumni->map(function($alumni) {
          return [
            'email' => $alumni->email,
            'student_id' => $alumni->student_id,
            'fullname' => $alumni->fullname,
            'can_reset_password' => method_exists($alumni, 'sendPasswordResetNotification'),
            'implements_canresetpassword' => in_array('Illuminate\Auth\Passwords\CanResetPassword', class_uses($alumni)),
          ];
        }),
      ],
      'routes_available' => [
        'forgot_password' => route('password.request'),
        'password_email' => route('password.email'),
        'password_reset' => 'Available with token',
        'password_store' => route('password.store'),
      ],
      'mail_config' => [
        'default_mailer' => config('mail.default'),
        'from_address' => config('mail.from.address'),
        'from_name' => config('mail.from.name'),
      ]
    ];

    return response()->json($result, 200, [], JSON_PRETTY_PRINT);
  } catch (\Exception $e) {
    return response()->json([
      'error' => $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ], 500, [], JSON_PRETTY_PRINT);
  }
})->name('debug.password.reset');

// Test SMTP configuration
Route::get('/test-smtp-config', function() {
  try {
    $config = [
      'mail_mailer' => config('mail.default'),
      'mail_host' => config('mail.mailers.smtp.host'),
      'mail_port' => config('mail.mailers.smtp.port'),
      'mail_username' => config('mail.mailers.smtp.username') ? 'Set (hidden)' : 'Not set',
      'mail_password' => config('mail.mailers.smtp.password') ? 'Set (hidden)' : 'Not set',
      'mail_encryption' => config('mail.mailers.smtp.encryption'),
      'mail_from_address' => config('mail.from.address'),
      'mail_from_name' => config('mail.from.name'),
    ];

    return response()->json([
      'status' => 'SMTP Configuration',
      'config' => $config,
      'ready_to_send' => config('mail.mailers.smtp.username') && config('mail.mailers.smtp.password'),
      'test_instructions' => [
        'To test password reset email, visit:',
        url('/test-password-reset-email/{email}'),
        'Replace {email} with a valid email from your database'
      ]
    ], 200, [], JSON_PRETTY_PRINT);
  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Failed to load SMTP configuration',
      'message' => $e->getMessage()
    ], 500, [], JSON_PRETTY_PRINT);
  }
})->name('test.smtp.config');

// Email setup helper page
Route::get('/email-setup', function() {
  $currentConfig = [
    'mail_mailer' => config('mail.default'),
    'mail_host' => config('mail.mailers.smtp.host'),
    'mail_port' => config('mail.mailers.smtp.port'),
    'mail_username' => config('mail.mailers.smtp.username'),
    'mail_password' => config('mail.mailers.smtp.password') ? 'Set (hidden)' : 'Not set',
    'mail_encryption' => config('mail.mailers.smtp.encryption'),
    'mail_from_address' => config('mail.from.address'),
    'mail_from_name' => config('mail.from.name'),
  ];

  $isConfigured = !empty(config('mail.mailers.smtp.username')) && !empty(config('mail.mailers.smtp.password'));

  return view('admin.email-setup', compact('currentConfig', 'isConfigured'));
})->name('email.setup');

// Debug route to check dean accounts and login
Route::get('/debug-dean-accounts', function() {
  try {
    // Check if dean accounts exist
    $deans = \App\Models\RoleAccount::where('account_type', 'dean')->get();

    $result = [
      'total_deans' => $deans->count(),
      'dean_accounts' => $deans->map(function($dean) {
        return [
          'email' => $dean->email,
          'student_id' => $dean->student_id,
          'department' => $dean->department,
          'status' => $dean->status,
          'account_type' => $dean->account_type
        ];
      }),
      'authentication_test' => []
    ];

    // Test authentication for each dean
    foreach($deans as $dean) {
      try {
        // Test if we can authenticate this dean
        $canAuth = \Illuminate\Support\Facades\Hash::check('password123', $dean->password);
        $result['authentication_test'][$dean->email] = [
          'password_check' => $canAuth,
          'status_active' => $dean->status == '1',
          'can_login' => $canAuth && $dean->status == '1'
        ];
      } catch (\Exception $e) {
        $result['authentication_test'][$dean->email] = [
          'error' => $e->getMessage()
        ];
      }
    }

    return response()->json($result, 200, [], JSON_PRETTY_PRINT);
  } catch (\Exception $e) {
    return response()->json([
      'error' => $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ], 500, [], JSON_PRETTY_PRINT);
  }
})->name('debug.dean.accounts');

// Debug route to check moderator print applications
Route::get('/debug-moderator-print', function() {
  $applications = \App\Models\GoodMoralApplication::where('application_status', 'Ready for Moderator Print')->get();

  return response()->json([
    'ready_for_print_count' => $applications->count(),
    'applications' => $applications->map(function($app) {
      $receipt = \App\Models\Receipt::where('reference_num', $app->reference_number)->first();
      return [
        'id' => $app->id,
        'reference_number' => $app->reference_number,
        'student_id' => $app->student_id,
        'fullname' => $app->fullname,
        'application_status' => $app->application_status,
        'certificate_type' => $app->certificate_type,
        'has_receipt' => $receipt ? true : false,
        'receipt_path' => $receipt ? $receipt->document_path : null
      ];
    })
  ]);
})->name('debug.moderator.print');

// Debug route to check admin ready for print applications
Route::get('/debug-admin-print', function() {
  $applications = \App\Models\GoodMoralApplication::where('application_status', 'Approved by Administrator')->get();

  return response()->json([
    'admin_approved_count' => $applications->count(),
    'applications' => $applications->map(function($app) {
      $receipt = \App\Models\Receipt::where('reference_num', $app->reference_number)->first();
      return [
        'id' => $app->id,
        'reference_number' => $app->reference_number,
        'student_id' => $app->student_id,
        'fullname' => $app->fullname,
        'application_status' => $app->application_status,
        'certificate_type' => $app->certificate_type,
        'has_receipt' => $receipt ? true : false,
        'receipt_path' => $receipt ? $receipt->document_path : null
      ];
    })
  ]);
})->name('debug.admin.print');

// Test route to create admin ready for print application
Route::get('/create-test-admin-print', function() {
  try {
    // Find or create a test student
    $student = \App\Models\RoleAccount::where('student_id', 'TEST-ADMIN-001')->first();
    if (!$student) {
      $student = \App\Models\RoleAccount::create([
        'student_id' => 'TEST-ADMIN-001',
        'fullname' => 'TEST ADMIN PRINT STUDENT',
        'department' => 'SITE',
        'account_type' => 'student',
        'email' => 'testadminprint@test.com',
        'password' => bcrypt('password'),
        'status' => '1'
      ]);
    }

    // Create a test application with "Approved by Administrator" status
    $application = \App\Models\GoodMoralApplication::create([
      'number_of_copies' => '1',
      'reference_number' => 'REF-ADMIN-TEST-001',
      'fullname' => $student->fullname,
      'gender' => 'Male',
      'reason' => 'Employment',
      'student_id' => $student->student_id,
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'status' => 'approved',
      'application_status' => 'Approved by Administrator',
    ]);

    // Create a test receipt
    $receipt = \App\Models\Receipt::create([
      'reference_num' => $application->reference_number,
      'official_receipt_no' => 'OR-TEST-001',
      'date_paid' => now()->format('Y-m-d'),
      'document_path' => 'receipts/test_receipt.pdf',
    ]);

    return response()->json([
      'success' => true,
      'message' => 'Test application and receipt created successfully!',
      'application' => $application->toArray(),
      'receipt' => $receipt->toArray(),
      'student' => $student->toArray(),
    ]);
  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Error creating test data: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ]);
  }
})->name('create.test.admin.print');

// Test route to check admin print certificate functionality
Route::get('/test-admin-print-cert/{id}', function($id) {
  try {
    $application = \App\Models\GoodMoralApplication::findOrFail($id);
    $receipt = \App\Models\Receipt::where('reference_num', $application->reference_number)->first();

    return response()->json([
      'application_found' => true,
      'application_status' => $application->application_status,
      'receipt_found' => $receipt ? true : false,
      'receipt_path' => $receipt ? $receipt->document_path : null,
      'print_route' => route('admin.printCertificate', $id),
      'application' => $application->toArray(),
      'receipt' => $receipt ? $receipt->toArray() : null,
    ]);
  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Error: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ]);
  }
})->name('test.admin.print.cert');

// Comprehensive debug route for admin print functionality
Route::get('/debug-admin-full', function() {
  try {
    // Check all applications
    $allApplications = \App\Models\GoodMoralApplication::all();
    $adminApprovedApps = \App\Models\GoodMoralApplication::where('application_status', 'Approved by Administrator')->get();
    $allReceipts = \App\Models\Receipt::all();

    // Check what the admin controller method returns
    $adminController = new \App\Http\Controllers\AdminController();

    // Simulate the readyForPrintApplications method logic
    $readyApps = \App\Models\GoodMoralApplication::where('application_status', 'Approved by Administrator')
      ->orderBy('updated_at', 'desc')
      ->get();

    $readyAppsWithReceipts = $readyApps->filter(function($application) {
      $receipt = \App\Models\Receipt::where('reference_num', $application->reference_number)
        ->whereNotNull('document_path')
        ->first();
      return $receipt !== null;
    });

    return response()->json([
      'total_applications' => $allApplications->count(),
      'admin_approved_applications' => $adminApprovedApps->count(),
      'total_receipts' => $allReceipts->count(),
      'ready_for_print_count' => $readyAppsWithReceipts->count(),
      'admin_approved_details' => $adminApprovedApps->map(function($app) {
        $receipt = \App\Models\Receipt::where('reference_num', $app->reference_number)->first();
        return [
          'id' => $app->id,
          'reference_number' => $app->reference_number,
          'student_id' => $app->student_id,
          'fullname' => $app->fullname,
          'application_status' => $app->application_status,
          'has_receipt' => $receipt ? true : false,
          'receipt_has_path' => $receipt && $receipt->document_path ? true : false,
          'receipt_path' => $receipt ? $receipt->document_path : null,
        ];
      }),
      'all_application_statuses' => $allApplications->pluck('application_status')->unique()->values(),
      'receipt_reference_numbers' => $allReceipts->pluck('reference_num'),
    ]);
  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Error: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ]);
  }
})->name('debug.admin.full');

// Test admin ready for print page without authentication
Route::get('/test-admin-ready-print', function() {
  try {
    // Get applications that have been approved by admin and have receipt uploaded
    $applications = \App\Models\GoodMoralApplication::where('application_status', 'Approved by Administrator')
      ->orderBy('updated_at', 'desc')
      ->get();

    // Filter applications that have receipts with uploaded documents
    $applications = $applications->filter(function($application) {
      $receipt = \App\Models\Receipt::where('reference_num', $application->reference_number)
        ->whereNotNull('document_path')
        ->first();
      return $receipt !== null;
    });

    return view('admin.ReadyForPrintApplications', compact('applications'));
  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Error: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ]);
  }
})->name('test.admin.ready.print');




// DEAN ROUTES ======================================================================================
Route::prefix('dean')->name('dean.')->middleware(['auth', 'verified'])->group(function () {
  Route::get('/dashboard', [DeanController::class, 'dashboard'])->name('dashboard');
  Route::get('/application', [DeanController::class, 'application'])->name('application');
  Route::patch('/application/{id}/approve', [DeanController::class, 'approve'])->name('approve');
  Route::delete('/application/{id}/reject', [DeanController::class, 'reject'])->name('reject');
  Route::get('/notification-counts', [DeanController::class, 'getNotificationCounts'])->name('notificationCounts');

  // Good Moral Application routes
  Route::patch('/good-moral/{id}/approve', [DeanController::class, 'approveGoodMoral'])->name('approveGoodMoral');
  Route::patch('/good-moral/{id}/reject', [DeanController::class, 'rejectGoodMoral'])->name('rejectGoodMoral');

  // New rejection routes with reasons
  Route::patch('/reject/{id}', [DeanController::class, 'rejectWithReason'])->name('reject');
  Route::patch('/reconsider/{id}', [DeanController::class, 'reconsider'])->name('reconsider');
  Route::get('/application/{id}/details', [DeanController::class, 'getApplicationDetails'])->name('application.details');

  Route::get('/major', [DeanController::class, 'major'])->name('major');
  Route::get('/minor', [DeanController::class, 'minor'])->name('minor');
  Route::post('/violation/{id}/approve', [DeanController::class, 'deanviolationapprove'])->name('violation.approve');
});

// Temporarily remove auth middleware
Route::post('/apply/good-moral-certificate', [ApplicationController::class, 'applyForGoodMoralCertificate'])->name('apply.good_moral_certificate');

Route::middleware('auth')->group(function () {
    Route::get('/profile', [ProfileController::class, 'edit'])->name('profile.edit');
    Route::patch('/profile', [ProfileController::class, 'update'])->name('profile.update');
    Route::delete('/profile', [ProfileController::class, 'destroy'])->name('profile.destroy');

    // Email update routes
    Route::post('/profile/update-email', [ProfileController::class, 'updateEmail'])->name('profile.update-email');
    Route::get('/profile/verify-email/{token}', [ProfileController::class, 'verifyEmailChange'])->name('profile.verify-email');

    // Admin profile routes
    Route::get('/profile/admin', [ProfileController::class, 'adminProfile'])->name('profile.admin');
    Route::patch('/profile/admin', [ProfileController::class, 'updateAdminProfile'])->name('profile.admin.update');
    
    // Moderator profile routes
    Route::get('/profile/moderator', [ProfileController::class, 'moderatorProfile'])->name('profile.moderator');
    Route::patch('/profile/moderator', [ProfileController::class, 'updateModeratorProfile'])->name('profile.moderator.update');
});

// Graduation status routes
Route::post('/profile/graduation-status', [ProfileController::class, 'updateGraduationStatus'])
  ->middleware(['auth', 'verified'])
  ->name('profile.graduation.update');
Route::post('/profile/convert-to-alumni', [ProfileController::class, 'convertToAlumni'])
  ->middleware(['auth', 'verified'])
  ->name('profile.convert.alumni');
// Program Coordinator ROUTES ======================================================================================
// Dashboard and minor violations removed - Program Coordinators only view major violations from their department
// Route::get('/prog_coor/dashboard', [ProgramCoordinatorController::class, 'dashboard'])
//   ->middleware(['auth', 'verified'])
//   ->name('prog_coor.dashboard');

// Route::get('/prog_coor/minor', [ProgramCoordinatorController::class, 'minor'])
//   ->middleware(['auth', 'verified'])
//   ->name('prog_coor.minor');

Route::get('/prog_coor/major', [ProgramCoordinatorController::class, 'major'])
  ->middleware(['auth', 'verified'])
  ->name('prog_coor.major');

// Program Coordinator view-only proceedings route
Route::get('/prog_coor/major/{id}/download-proceedings', [ProgramCoordinatorController::class, 'downloadProceedings'])
  ->middleware(['auth', 'verified'])
  ->name('prog_coor.downloadProceedings');

// Moderator proceedings upload routes
Route::get('/sec_osa/major/{id}/upload-proceedings', [SecOSAController::class, 'showUploadProceedings'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.showUploadProceedings');

Route::post('/sec_osa/major/{id}/upload-proceedings', [SecOSAController::class, 'uploadProceedings'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.uploadProceedings');

// Moderator download proceedings route
Route::get('/sec_osa/major/{id}/download-proceedings', [SecOSAController::class, 'downloadProceedings'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.downloadProceedings');

// Search routes for violations
Route::get('/sec_osa/minor/search', [SecOSAController::class, 'searchMinor'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.searchMinor');

Route::get('/sec_osa/major/search', [SecOSAController::class, 'searchMajor'])
  ->middleware(['auth', 'verified'])
  ->name('sec_osa.searchMajor');

// Program Coordinator search route
Route::get('/prog_coor/major/search', [ProgramCoordinatorController::class, 'CoorMajorSearch'])
  ->middleware(['auth', 'verified'])
  ->name('CoorMajorSearch');

// Re-enable auth routes now that basic auth is working
require __DIR__ . '/auth.php';

// Auth routes are now provided by auth.php

// Routes from auth.php are now available

// Test trends data route
Route::get('/test-trends-data', function() {
  try {
    $adminController = new \App\Http\Controllers\AdminController();
    $reflection = new ReflectionClass($adminController);
    $method = $reflection->getMethod('getTrendsAnalysisData');
    $method->setAccessible(true);
    $trendsData = $method->invoke($adminController);

    return response()->json($trendsData, 200, [], JSON_PRETTY_PRINT);
  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Trends data error: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ], 500, [], JSON_PRETTY_PRINT);
  }
})->name('test.trends.data');

// Test minor offenses overall report data
Route::get('/test-minor-offenses-data', function() {
  try {
    $adminController = new \App\Http\Controllers\AdminController();
    $reflection = new ReflectionClass($adminController);
    $method = $reflection->getMethod('generateMinorOffensesOverallReport');
    $method->setAccessible(true);

    // Test with sample data
    $academicYear = '2024-2025';
    $startDate = '2024-08-01';
    $endDate = '2025-07-31';

    // Since this method returns a PDF download, let's just test the data structure
    // by creating a modified version that returns the data instead
    $departmentsData = [
      'SITE' => [
        'total_population' => 640,
        'violators_2023_2024' => 118,
        'violators_june_2025' => 23,
      ],
      'SBAHM' => [
        'total_population' => 727,
        'violators_2023_2024' => 88,
        'violators_june_2025' => 21,
      ],
      'SNAHS' => [
        'total_population' => 2831,
        'violators_2023_2024' => 524,
        'violators_june_2025' => 77,
      ],
      'SASTE' => [
        'total_population' => 409,
        'violators_2023_2024' => 97,
        'violators_june_2025' => 12,
      ]
    ];

    $trendsData = [];
    $totals = [
      'total_population' => 0,
      'violators_2023_2024' => 0,
      'violators_june_2025' => 0,
      'total_variance' => 0,
    ];

    foreach ($departmentsData as $dept => $data) {
      $previousViolators = $data['violators_2023_2024'];
      $juneViolators = $data['violators_june_2025'];
      $variancePercentage = $previousViolators > 0
        ? round((($previousViolators - $juneViolators) / $previousViolators) * 100, 1)
        : 0;
      $rawDifference = $juneViolators - $previousViolators;

      $trendsData[$dept] = [
        'department' => $dept,
        'total_population' => $data['total_population'],
        'violators_2023_2024' => $data['violators_2023_2024'],
        'violators_june_2025' => $data['violators_june_2025'],
        'variance' => $rawDifference,
        'variance_percentage' => $variancePercentage,
        'trend' => $rawDifference > 0 ? 'increase' : ($rawDifference < 0 ? 'decrease' : 'stable')
      ];

      $totals['total_population'] += $data['total_population'];
      $totals['violators_2023_2024'] += $data['violators_2023_2024'];
      $totals['violators_june_2025'] += $data['violators_june_2025'];
      $totals['total_variance'] += $rawDifference;
    }

    return response()->json([
      'report_title' => 'Overall Report on Minor Offenses as of June 2025',
      'academic_year' => $academicYear,
      'departments_data' => $trendsData,
      'totals' => $totals,
    ], 200, [], JSON_PRETTY_PRINT);

  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Minor offenses data error: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ], 500, [], JSON_PRETTY_PRINT);
  }
})->name('test.minor.offenses.data');

// Test admin dashboard with trends analysis (no auth required)
Route::get('/test-admin-dashboard', function() {
  try {
    // Create a mock request
    $request = new \Illuminate\Http\Request();

    // Create admin controller instance
    $adminController = new \App\Http\Controllers\AdminController();

    // Mock authentication
    $admin = \App\Models\RoleAccount::where('account_type', 'admin')->first();
    if (!$admin) {
      // Create a test admin if none exists
      $admin = \App\Models\RoleAccount::create([
        'email' => 'test.admin@example.com',
        'fullname' => 'Test Admin',
        'student_id' => 'ADMIN-TEST',
        'account_type' => 'admin',
        'status' => '1',
        'password' => bcrypt('password123'),
      ]);
    }

    // Manually authenticate the admin
    \Illuminate\Support\Facades\Auth::login($admin);

    // Call the dashboard method
    return $adminController->dashboard($request);
  } catch (\Exception $e) {
    return response()->json([
      'error' => 'Admin dashboard error: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ], 500);
  }
})->name('test.admin.dashboard');

Route::get('/test-dean-dashboard', function() {
  try {
    return app(\App\Http\Controllers\DeanController::class)->dashboard();
  } catch (\Exception $e) {
    return [
      'error' => 'Dean dashboard error: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('test.dean.dashboard');

// Test dean application with authentication
Route::get('/test-dean-application', function() {
  try {
    // Simulate login as SITE dean
    $dean = \App\Models\RoleAccount::where('student_id', 'DEAN_SITE')->first();
    if (!$dean) {
      return ['error' => 'SITE dean not found'];
    }

    // Manually authenticate the dean
    Auth::login($dean);

    return app(\App\Http\Controllers\DeanController::class)->application();
  } catch (\Exception $e) {
    return [
      'error' => 'Dean application error: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('test.dean.application');

// Debug route to check applications
Route::get('/debug-dean-applications', function() {
  try {
    $dean = \App\Models\RoleAccount::where('student_id', 'DEAN_SITE')->first();
    if (!$dean) {
      return ['error' => 'SITE dean not found'];
    }

    // Check all applications in the system
    $allApplications = \App\Models\GoodMoralApplication::all();

    // Check applications for this dean's department
    $deanDeptApplications = \App\Models\GoodMoralApplication::where('department', $dean->department)->get();

    // Check applications with registrar approval
    $registrarApproved = \App\Models\GoodMoralApplication::where('application_status', 'LIKE', 'Approved By Registrar%')->get();

    return [
      'dean_department' => $dean->department,
      'total_applications' => $allApplications->count(),
      'dean_dept_applications' => $deanDeptApplications->count(),
      'registrar_approved' => $registrarApproved->count(),
      'sample_applications' => $allApplications->take(3)->map(function($app) {
        return [
          'id' => $app->id,
          'student_id' => $app->student_id,
          'department' => $app->department,
          'application_status' => $app->application_status,
          'certificate_type' => $app->certificate_type,
          'status' => $app->status
        ];
      })
    ];
  } catch (\Exception $e) {
    return [
      'error' => 'Debug error: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('debug.dean.applications');

// Create test applications
Route::get('/create-test-applications', function() {
  try {
    // Create a test student for SITE department
    $student = \App\Models\RoleAccount::firstOrCreate([
      'student_id' => 'TEST_STUDENT_SITE'
    ], [
      'email' => 'test.student.site@example.com',
      'department' => 'SITE',
      'password' => \Illuminate\Support\Facades\Hash::make('password123'),
      'account_type' => 'student',
      'fullname' => 'Test Student SITE',
      'status' => '1',
    ]);

    // Create a test registrar
    $registrar = \App\Models\RoleAccount::where('account_type', 'registrar')->first();
    if (!$registrar) {
      return ['error' => 'No registrar found'];
    }

    // Create test Good Moral Application
    $goodMoralApp = \App\Models\GoodMoralApplication::create([
      'number_of_copies' => '1',
      'reference_number' => 'REF-TEST-GM-001',
      'fullname' => $student->fullname,
      'reason' => 'Employment',
      'student_id' => $student->student_id,
      'department' => $student->department,
      'certificate_type' => 'good_moral',
      'status' => 'approved',
      'application_status' => 'Approved By Registrar ' . $registrar->fullname,
    ]);

    // Create test Residency Application
    $residencyApp = \App\Models\GoodMoralApplication::create([
      'number_of_copies' => '2',
      'reference_number' => 'REF-TEST-RES-001',
      'fullname' => $student->fullname,
      'reason' => 'Transfer',
      'student_id' => $student->student_id,
      'department' => $student->department,
      'certificate_type' => 'residency',
      'status' => 'approved',
      'application_status' => 'Approved By Registrar ' . $registrar->fullname,
    ]);

    return [
      'success' => 'Test applications created successfully',
      'student' => $student->toArray(),
      'good_moral_app' => $goodMoralApp->toArray(),
      'residency_app' => $residencyApp->toArray(),
    ];
  } catch (\Exception $e) {
    return [
      'error' => 'Error creating test applications: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('create.test.applications');

Route::get('/test-registrar-dashboard', function() {
  try {
    return app(\App\Http\Controllers\RegistrarController::class)->goodMoralApplication();
  } catch (\Exception $e) {
    return [
      'error' => 'Registrar dashboard error: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('test.registrar.dashboard');

Route::get('/test-psg-dashboard', function() {
  try {
    return app(\App\Http\Controllers\Auth\RegisterViolationController::class)->dashboard();
  } catch (\Exception $e) {
    return [
      'error' => 'PSG dashboard error: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('test.psg.dashboard');

// Quick test for registrar dashboard specifically
Route::get('/quick-registrar-test', function() {
  // Simulate being logged in as registrar
  if (!auth()->check()) {
    return 'Please login first at: ' . route('login');
  }

  $user = auth()->user();
  if ($user->account_type !== 'registrar') {
    return 'Please login as registrar. Current user type: ' . $user->account_type;
  }

  try {
    return app(\App\Http\Controllers\RegistrarController::class)->goodMoralApplication();
  } catch (\Exception $e) {
    return [
      'error' => 'Registrar dashboard error: ' . $e->getMessage(),
      'file' => $e->getFile(),
      'line' => $e->getLine(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('quick.registrar.test');

// Quick dean test
Route::get('/quick-dean-test', function() {
  try {
    // Check if dean exists
    $dean = \App\Models\RoleAccount::where('student_id', 'DEAN_SITE')->first();
    if (!$dean) {
      return [
        'error' => 'DEAN_SITE not found',
        'available_deans' => \App\Models\RoleAccount::where('account_type', 'dean')->pluck('student_id', 'fullname')
      ];
    }

    // Check applications in database
    $allApps = \App\Models\GoodMoralApplication::all();
    $siteApps = \App\Models\GoodMoralApplication::where('department', 'SITE')->get();
    $registrarApproved = \App\Models\GoodMoralApplication::where('application_status', 'LIKE', '%Approved By Registrar%')->get();

    return [
      'dean_info' => [
        'student_id' => $dean->student_id,
        'fullname' => $dean->fullname,
        'department' => $dean->department,
        'account_type' => $dean->account_type
      ],
      'application_counts' => [
        'total_applications' => $allApps->count(),
        'site_applications' => $siteApps->count(),
        'registrar_approved' => $registrarApproved->count()
      ],
      'sample_applications' => $allApps->take(3)->map(function($app) {
        return [
          'id' => $app->id,
          'student_id' => $app->student_id,
          'department' => $app->department,
          'application_status' => $app->application_status,
          'certificate_type' => $app->certificate_type,
          'status' => $app->status,
          'created_at' => $app->created_at
        ];
      }),
      'dean_login_url' => route('login') . '?email=deanSITE@admin.com&password=password123'
    ];
  } catch (\Exception $e) {
    return [
      'error' => 'Quick dean test error: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('quick.dean.test');

// Complete dean application diagnosis
Route::get('/diagnose-dean-applications', function() {
  try {
    // Step 1: Check dean accounts
    $deans = \App\Models\RoleAccount::where('account_type', 'dean')->get();

    // Step 2: Check applications
    $allApps = \App\Models\GoodMoralApplication::all();

    // Step 3: Check registrar approved applications
    $registrarApproved = \App\Models\GoodMoralApplication::where('application_status', 'LIKE', '%Approved%')->get();

    // Step 4: Test dean login and application access
    $testResults = [];

    foreach ($deans as $dean) {
      // Simulate dean login
      Auth::login($dean);

      try {
        // Test the dean application method
        $controller = new \App\Http\Controllers\DeanController();
        $result = $controller->application();

        $testResults[$dean->student_id] = [
          'login_success' => true,
          'application_method_success' => true,
          'result_type' => get_class($result)
        ];
      } catch (\Exception $e) {
        $testResults[$dean->student_id] = [
          'login_success' => true,
          'application_method_success' => false,
          'error' => $e->getMessage()
        ];
      }

      Auth::logout();
    }

    return [
      'dean_accounts' => $deans->map(function($dean) {
        return [
          'student_id' => $dean->student_id,
          'fullname' => $dean->fullname,
          'department' => $dean->department,
          'email' => $dean->email,
          'status' => $dean->status
        ];
      }),
      'application_summary' => [
        'total_applications' => $allApps->count(),
        'registrar_approved' => $registrarApproved->count(),
        'by_department' => $allApps->groupBy('department')->map->count(),
        'by_status' => $allApps->groupBy('application_status')->map->count()
      ],
      'sample_applications' => $allApps->take(5)->map(function($app) {
        return [
          'id' => $app->id,
          'student_id' => $app->student_id,
          'department' => $app->department,
          'application_status' => $app->application_status,
          'certificate_type' => $app->certificate_type,
          'created_at' => $app->created_at
        ];
      }),
      'dean_test_results' => $testResults,
      'recommendations' => [
        'create_test_data' => 'Visit /create-test-applications to create sample data',
        'login_as_dean' => 'Use email: deanSITE@admin.com, password: password123',
        'direct_access' => 'Visit /dean/application after logging in'
      ]
    ];

  } catch (\Exception $e) {
    return [
      'error' => 'Diagnosis failed: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('diagnose.dean.applications');

// Test dean dashboard department filtering
Route::get('/test-dean-dashboard-filter', function() {
  try {
    // Test with SBAHM dean
    $dean = \App\Models\RoleAccount::where('student_id', 'DEAN_SBAHM')->first();
    if (!$dean) {
      return ['error' => 'DEAN_SBAHM not found'];
    }

    Auth::login($dean);

    // Get application counts by department
    $allApps = \App\Models\GoodMoralApplication::all();
    $deanDeptApps = \App\Models\GoodMoralApplication::where('department', $dean->department)->get();

    // Test specific course counts for SBAHM
    $bsaCount = \App\Models\GoodMoralApplication::where('course_completed', 'BSA')
      ->where('department', $dean->department)
      ->count();

    $bseCount = \App\Models\GoodMoralApplication::where('course_completed', 'BSE')
      ->where('department', $dean->department)
      ->count();

    Auth::logout();

    return [
      'dean_info' => [
        'student_id' => $dean->student_id,
        'department' => $dean->department,
        'fullname' => $dean->fullname
      ],
      'application_counts' => [
        'total_system_apps' => $allApps->count(),
        'dean_dept_apps' => $deanDeptApps->count(),
        'bsa_in_dept' => $bsaCount,
        'bse_in_dept' => $bseCount
      ],
      'apps_by_department' => $allApps->groupBy('department')->map->count(),
      'apps_by_course' => $allApps->groupBy('course_completed')->map->count(),
      'sample_dept_apps' => $deanDeptApps->take(3)->map(function($app) {
        return [
          'id' => $app->id,
          'student_id' => $app->student_id,
          'department' => $app->department,
          'course_completed' => $app->course_completed
        ];
      })
    ];

  } catch (\Exception $e) {
    return [
      'error' => 'Test failed: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('test.dean.dashboard.filter');

// Create test applications for SBAHM department
Route::get('/create-sbahm-test-data', function() {
  try {
    // Create test students for SBAHM department
    $student1 = \App\Models\RoleAccount::firstOrCreate([
      'student_id' => 'TEST_SBAHM_BSA'
    ], [
      'email' => 'test.sbahm.bsa@example.com',
      'department' => 'SBAHM',
      'password' => \Illuminate\Support\Facades\Hash::make('password123'),
      'account_type' => 'student',
      'fullname' => 'Test Student BSA SBAHM',
      'status' => '1',
    ]);

    $student2 = \App\Models\RoleAccount::firstOrCreate([
      'student_id' => 'TEST_SBAHM_BSE'
    ], [
      'email' => 'test.sbahm.bse@example.com',
      'department' => 'SBAHM',
      'password' => \Illuminate\Support\Facades\Hash::make('password123'),
      'account_type' => 'student',
      'fullname' => 'Test Student BSE SBAHM',
      'status' => '1',
    ]);

    // Get registrar
    $registrar = \App\Models\RoleAccount::where('account_type', 'registrar')->first();
    if (!$registrar) {
      return ['error' => 'No registrar found'];
    }

    // Create test applications for SBAHM
    $app1 = \App\Models\GoodMoralApplication::create([
      'number_of_copies' => '1',
      'reference_number' => 'REF-SBAHM-BSA-001',
      'fullname' => $student1->fullname,
      'reason' => 'Employment',
      'student_id' => $student1->student_id,
      'department' => 'SBAHM',
      'course_completed' => 'BSA',
      'certificate_type' => 'good_moral',
      'status' => 'approved',
      'application_status' => 'Approved By Registrar ' . $registrar->fullname,
    ]);

    $app2 = \App\Models\GoodMoralApplication::create([
      'number_of_copies' => '2',
      'reference_number' => 'REF-SBAHM-BSE-001',
      'fullname' => $student2->fullname,
      'reason' => 'Transfer',
      'student_id' => $student2->student_id,
      'department' => 'SBAHM',
      'course_completed' => 'BSE',
      'certificate_type' => 'residency',
      'status' => 'approved',
      'application_status' => 'Approved By Registrar ' . $registrar->fullname,
    ]);

    return [
      'success' => 'SBAHM test data created successfully',
      'students' => [
        $student1->toArray(),
        $student2->toArray()
      ],
      'applications' => [
        $app1->toArray(),
        $app2->toArray()
      ],
      'next_step' => 'Login as SBAHM dean and check dashboard'
    ];

  } catch (\Exception $e) {
    return [
      'error' => 'Error creating SBAHM test data: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('create.sbahm.test.data');

// Create test applications for dean dashboard debugging
Route::get('/debug-dean-dashboard', function() {
  try {
    // Step 1: Check current dean accounts
    $deans = \App\Models\RoleAccount::where('account_type', 'dean')->get();

    // Step 2: Check current applications
    $allApps = \App\Models\GoodMoralApplication::all();

    // Step 3: Create test data if needed
    $testStudent = \App\Models\RoleAccount::firstOrCreate([
      'student_id' => 'DEAN_TEST_STUDENT'
    ], [
      'email' => 'dean.test.student@example.com',
      'department' => 'SITE',
      'password' => \Illuminate\Support\Facades\Hash::make('password123'),
      'account_type' => 'student',
      'fullname' => 'Dean Test Student',
      'status' => '1',
    ]);

    // Get registrar for approval
    $registrar = \App\Models\RoleAccount::where('account_type', 'registrar')->first();
    if (!$registrar) {
      return ['error' => 'No registrar found in system'];
    }

    // Create test applications with correct status for dean approval
    $goodMoralApp = \App\Models\GoodMoralApplication::create([
      'number_of_copies' => '1',
      'reference_number' => 'REF-DEAN-TEST-GM-' . time(),
      'fullname' => $testStudent->fullname,
      'gender' => 'male',
      'reason' => ['Employment'],
      'student_id' => $testStudent->student_id,
      'department' => $testStudent->department,
      'certificate_type' => 'good_moral',
      'status' => 'approved',
      'application_status' => 'Approved By Registrar ' . $registrar->fullname,
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT 4th Year',
      'last_semester_sy' => 'First Semester 2024-2025',
    ]);

    $residencyApp = \App\Models\GoodMoralApplication::create([
      'number_of_copies' => '2',
      'reference_number' => 'REF-DEAN-TEST-RES-' . time(),
      'fullname' => $testStudent->fullname,
      'gender' => 'male',
      'reason' => ['Transfer'],
      'student_id' => $testStudent->student_id,
      'department' => $testStudent->department,
      'certificate_type' => 'residency',
      'status' => 'approved',
      'application_status' => 'Approved By Registrar ' . $registrar->fullname,
      'is_undergraduate' => true,
      'last_course_year_level' => 'BSIT 4th Year',
      'last_semester_sy' => 'First Semester 2024-2025',
    ]);

    // Test dean dashboard query
    $siteDean = \App\Models\RoleAccount::where('student_id', 'DEAN_SITE')->first();
    if ($siteDean) {
      // Test the exact query used in dean dashboard
      $pendingGoodMoral = \App\Models\GoodMoralApplication::where(function($query) {
          $query->where('application_status', 'LIKE', 'Approved By Registrar%')
                ->orWhere('application_status', 'LIKE', 'Approved by Registrar%')
                ->orWhere('application_status', '=', 'Approved By Registrar')
                ->orWhere('application_status', '=', 'Approved by Registrar');
        })
        ->where('department', $siteDean->department)
        ->where('certificate_type', 'good_moral')
        ->whereNotNull('application_status')
        ->get();

      $pendingResidency = \App\Models\GoodMoralApplication::where(function($query) {
          $query->where('application_status', 'LIKE', 'Approved By Registrar%')
                ->orWhere('application_status', 'LIKE', 'Approved by Registrar%')
                ->orWhere('application_status', '=', 'Approved By Registrar')
                ->orWhere('application_status', '=', 'Approved by Registrar');
        })
        ->where('department', $siteDean->department)
        ->where('certificate_type', 'residency')
        ->whereNotNull('application_status')
        ->get();
    }

    return [
      'success' => 'Dean dashboard debug completed',
      'dean_accounts' => $deans->map(function($dean) {
        return [
          'student_id' => $dean->student_id,
          'fullname' => $dean->fullname,
          'department' => $dean->department,
          'email' => $dean->email
        ];
      }),
      'total_applications' => $allApps->count(),
      'applications_by_status' => $allApps->groupBy('application_status')->map->count(),
      'applications_by_department' => $allApps->groupBy('department')->map->count(),
      'test_data_created' => [
        'student' => $testStudent->toArray(),
        'good_moral_app' => $goodMoralApp->toArray(),
        'residency_app' => $residencyApp->toArray()
      ],
      'dean_query_results' => isset($pendingGoodMoral) ? [
        'site_dean_exists' => $siteDean ? true : false,
        'pending_good_moral_count' => $pendingGoodMoral->count(),
        'pending_residency_count' => $pendingResidency->count(),
        'good_moral_apps' => $pendingGoodMoral->map(function($app) {
          return [
            'id' => $app->id,
            'application_status' => $app->application_status,
            'department' => $app->department,
            'certificate_type' => $app->certificate_type
          ];
        }),
        'residency_apps' => $pendingResidency->map(function($app) {
          return [
            'id' => $app->id,
            'application_status' => $app->application_status,
            'department' => $app->department,
            'certificate_type' => $app->certificate_type
          ];
        })
      ] : ['error' => 'SITE dean not found'],
      'next_steps' => [
        'login_url' => route('login'),
        'dean_credentials' => 'Email: deanSITE@admin.com, Password: password123',
        'dashboard_url' => route('dean.dashboard')
      ]
    ];

  } catch (\Exception $e) {
    return [
      'error' => 'Debug failed: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('debug.dean.dashboard');

// Test dean dashboard functionality directly
Route::get('/test-dean-dashboard-working', function() {
  try {
    // Find SITE dean
    $dean = \App\Models\RoleAccount::where('student_id', 'DEAN_SITE')->first();
    if (!$dean) {
      return ['error' => 'DEAN_SITE not found'];
    }

    // Simulate dean login
    Auth::login($dean);
    $department = $dean->department;

    // Test the exact queries from DeanController dashboard method
    $pendingGoodMoralApplications = \App\Models\GoodMoralApplication::where(function($query) {
        $query->where('application_status', 'LIKE', 'Approved By Registrar%')
              ->orWhere('application_status', 'LIKE', 'Approved by Registrar%')
              ->orWhere('application_status', '=', 'Approved By Registrar')
              ->orWhere('application_status', '=', 'Approved by Registrar');
      })
      ->where('department', $department)
      ->where('certificate_type', 'good_moral')
      ->whereNotNull('application_status')
      ->count();

    $pendingResidencyApplications = \App\Models\GoodMoralApplication::where(function($query) {
        $query->where('application_status', 'LIKE', 'Approved By Registrar%')
              ->orWhere('application_status', 'LIKE', 'Approved by Registrar%')
              ->orWhere('application_status', '=', 'Approved By Registrar')
              ->orWhere('application_status', '=', 'Approved by Registrar');
      })
      ->where('department', $department)
      ->where('certificate_type', 'residency')
      ->whereNotNull('application_status')
      ->count();

    // Get all applications for debugging
    $allAppsInDept = \App\Models\GoodMoralApplication::where('department', $department)->get();
    $allRegistrarApproved = \App\Models\GoodMoralApplication::where('application_status', 'LIKE', '%Approved%')->get();

    Auth::logout();

    return [
      'success' => 'Dean dashboard test completed',
      'dean_info' => [
        'student_id' => $dean->student_id,
        'fullname' => $dean->fullname,
        'department' => $dean->department
      ],
      'dashboard_counts' => [
        'pending_good_moral' => $pendingGoodMoralApplications,
        'pending_residency' => $pendingResidencyApplications,
        'total_pending' => $pendingGoodMoralApplications + $pendingResidencyApplications
      ],
      'debug_info' => [
        'all_apps_in_dept' => $allAppsInDept->count(),
        'all_registrar_approved' => $allRegistrarApproved->count(),
        'apps_in_dept' => $allAppsInDept->map(function($app) {
          return [
            'id' => $app->id,
            'application_status' => $app->application_status,
            'certificate_type' => $app->certificate_type,
            'department' => $app->department
          ];
        }),
        'registrar_approved' => $allRegistrarApproved->map(function($app) {
          return [
            'id' => $app->id,
            'application_status' => $app->application_status,
            'certificate_type' => $app->certificate_type,
            'department' => $app->department
          ];
        })
      ],
      'status_check' => [
        'looking_for_patterns' => [
          'Approved By Registrar%',
          'Approved by Registrar%',
          'Approved By Registrar',
          'Approved by Registrar'
        ],
        'department_filter' => $department,
        'certificate_types' => ['good_moral', 'residency']
      ]
    ];

  } catch (\Exception $e) {
    Auth::logout();
    return [
      'error' => 'Test failed: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('test.dean.dashboard.working');

// Fix dean dashboard by creating proper test data
Route::get('/fix-dean-dashboard', function() {
  try {
    // Step 1: Clear existing test data
    \App\Models\GoodMoralApplication::where('student_id', 'LIKE', 'DEAN_TEST_%')->delete();
    \App\Models\RoleAccount::where('student_id', 'LIKE', 'DEAN_TEST_%')->delete();

    // Step 2: Get registrar for approval
    $registrar = \App\Models\RoleAccount::where('account_type', 'registrar')->first();
    if (!$registrar) {
      return ['error' => 'No registrar found in system'];
    }

    // Step 3: Create test students for different departments
    $departments = ['SITE', 'SNAHS', 'SBAHM', 'SASTE'];
    $createdData = [];

    foreach ($departments as $dept) {
      // Create test student
      $student = \App\Models\RoleAccount::create([
        'student_id' => 'DEAN_TEST_' . $dept,
        'email' => 'dean.test.' . strtolower($dept) . '@example.com',
        'department' => $dept,
        'password' => \Illuminate\Support\Facades\Hash::make('password123'),
        'account_type' => 'student',
        'fullname' => 'Dean Test Student ' . $dept,
        'status' => '1',
      ]);

      // Create Good Moral Application awaiting dean approval
      $goodMoralApp = \App\Models\GoodMoralApplication::create([
        'number_of_copies' => '1',
        'reference_number' => 'REF-DEAN-GM-' . $dept . '-' . time(),
        'fullname' => $student->fullname,
        'gender' => 'male',
        'reason' => ['Employment'],
        'student_id' => $student->student_id,
        'department' => $student->department,
        'certificate_type' => 'good_moral',
        'status' => 'approved',
        'application_status' => 'Approved By Registrar ' . $registrar->fullname,
        'is_undergraduate' => true,
        'last_course_year_level' => 'BSIT 4th Year',
        'last_semester_sy' => 'First Semester 2024-2025',
      ]);

      // Create Residency Application awaiting dean approval
      $residencyApp = \App\Models\GoodMoralApplication::create([
        'number_of_copies' => '2',
        'reference_number' => 'REF-DEAN-RES-' . $dept . '-' . time(),
        'fullname' => $student->fullname,
        'gender' => 'male',
        'reason' => ['Transfer'],
        'student_id' => $student->student_id,
        'department' => $student->department,
        'certificate_type' => 'residency',
        'status' => 'approved',
        'application_status' => 'Approved By Registrar ' . $registrar->fullname,
        'is_undergraduate' => true,
        'last_course_year_level' => 'BSIT 4th Year',
        'last_semester_sy' => 'First Semester 2024-2025',
      ]);

      $createdData[$dept] = [
        'student' => $student->toArray(),
        'good_moral_app' => $goodMoralApp->toArray(),
        'residency_app' => $residencyApp->toArray()
      ];
    }

    // Step 4: Test dean dashboard for each department
    $testResults = [];
    foreach ($departments as $dept) {
      $dean = \App\Models\RoleAccount::where('student_id', 'DEAN_' . $dept)->first();
      if ($dean) {
        $pendingGoodMoral = \App\Models\GoodMoralApplication::where(function($query) {
            $query->where('application_status', 'LIKE', 'Approved By Registrar%')
                  ->orWhere('application_status', 'LIKE', 'Approved by Registrar%')
                  ->orWhere('application_status', '=', 'Approved By Registrar')
                  ->orWhere('application_status', '=', 'Approved by Registrar');
          })
          ->where('department', $dean->department)
          ->where('certificate_type', 'good_moral')
          ->whereNotNull('application_status')
          ->count();

        $pendingResidency = \App\Models\GoodMoralApplication::where(function($query) {
            $query->where('application_status', 'LIKE', 'Approved By Registrar%')
                  ->orWhere('application_status', 'LIKE', 'Approved by Registrar%')
                  ->orWhere('application_status', '=', 'Approved By Registrar')
                  ->orWhere('application_status', '=', 'Approved by Registrar');
          })
          ->where('department', $dean->department)
          ->where('certificate_type', 'residency')
          ->whereNotNull('application_status')
          ->count();

        $testResults[$dept] = [
          'dean_exists' => true,
          'dean_id' => $dean->student_id,
          'pending_good_moral' => $pendingGoodMoral,
          'pending_residency' => $pendingResidency,
          'total_pending' => $pendingGoodMoral + $pendingResidency
        ];
      } else {
        $testResults[$dept] = [
          'dean_exists' => false,
          'error' => 'Dean not found for department ' . $dept
        ];
      }
    }

    return [
      'success' => 'Dean dashboard fixed successfully!',
      'message' => 'Created test applications for all departments',
      'created_data' => $createdData,
      'test_results' => $testResults,
      'instructions' => [
        'login_as_dean' => 'Use credentials: deanSITE@admin.com / password123',
        'dashboard_url' => route('dean.dashboard'),
        'expected_result' => 'Should now see 1 Good Moral and 1 Residency application pending'
      ]
    ];

  } catch (\Exception $e) {
    return [
      'error' => 'Fix failed: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('fix.dean.dashboard');

// Final verification of dean dashboard functionality
Route::get('/verify-dean-dashboard', function() {
  try {
    // Test all dean accounts
    $departments = ['SITE', 'SNAHS', 'SBAHM', 'SASTE'];
    $results = [];

    foreach ($departments as $dept) {
      $dean = \App\Models\RoleAccount::where('student_id', 'DEAN_' . $dept)->first();

      if ($dean) {
        // Simulate dean login
        Auth::login($dean);

        // Test dean dashboard controller
        try {
          $controller = new \App\Http\Controllers\DeanController();
          $dashboardResult = $controller->dashboard(new \Illuminate\Http\Request());

          // Extract the data passed to the view
          $viewData = $dashboardResult->getData();

          $results[$dept] = [
            'dean_exists' => true,
            'dean_info' => [
              'student_id' => $dean->student_id,
              'fullname' => $dean->fullname,
              'department' => $dean->department
            ],
            'dashboard_success' => true,
            'pending_good_moral' => $viewData['pendingGoodMoralApplications'] ?? 0,
            'pending_residency' => $viewData['pendingResidencyApplications'] ?? 0,
            'total_pending' => ($viewData['pendingGoodMoralApplications'] ?? 0) + ($viewData['pendingResidencyApplications'] ?? 0)
          ];
        } catch (\Exception $e) {
          $results[$dept] = [
            'dean_exists' => true,
            'dashboard_success' => false,
            'error' => $e->getMessage()
          ];
        }

        Auth::logout();
      } else {
        $results[$dept] = [
          'dean_exists' => false,
          'error' => 'Dean account not found for ' . $dept
        ];
      }
    }

    // Overall summary
    $totalPendingAcrossAllDepts = 0;
    $workingDashboards = 0;

    foreach ($results as $dept => $result) {
      if (isset($result['total_pending'])) {
        $totalPendingAcrossAllDepts += $result['total_pending'];
      }
      if (isset($result['dashboard_success']) && $result['dashboard_success']) {
        $workingDashboards++;
      }
    }

    return [
      'success' => 'Dean dashboard verification completed',
      'summary' => [
        'total_departments_tested' => count($departments),
        'working_dashboards' => $workingDashboards,
        'total_pending_applications' => $totalPendingAcrossAllDepts,
        'all_dashboards_working' => $workingDashboards === count($departments)
      ],
      'department_results' => $results,
      'instructions' => [
        'login_credentials' => [
          'SITE' => 'deanSITE@admin.com / password123',
          'SNAHS' => 'deanSNAHS@admin.com / password123',
          'SBAHM' => 'deanSBAHM@admin.com / password123',
          'SASTE' => 'deanSASTE@admin.com / password123'
        ],
        'dashboard_url' => route('dean.dashboard'),
        'expected_behavior' => 'Each dean should see applications for their department only'
      ]
    ];

  } catch (\Exception $e) {
    Auth::logout();
    return [
      'error' => 'Verification failed: ' . $e->getMessage(),
      'trace' => $e->getTraceAsString()
    ];
  }
})->name('verify.dean.dashboard');


require __DIR__.'/auth.php';

